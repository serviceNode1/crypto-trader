<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Main CSS (includes all styles) -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h1>Crypto Trading Dashboard</h1>
                        <span class="paper-trading-badge" title="This system uses virtual money only. No real trades are executed.">
                            ‚ö†Ô∏è PAPER TRADING
                        </span>
                    </div>
                    <p class="subtitle">AI-Powered Paper Trading System | Starting Capital: $10,000</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="info-button" onclick="openSettingsModal()" title="Trading Settings">
                        ‚öôÔ∏è
                    </button>
                    <button class="info-button" onclick="openInfoModal()" title="Trading Guide & Information">
                        üí°
                    </button>
                </div>
            </div>
        </header>

        <!-- Crypto Selector -->
        <div class="card" style="margin-bottom: 30px;">
            <h2 onclick="toggleCardCollapse('crypto-selector-content')">
                <span>üîç Select Cryptocurrency to Analyze</span>
                <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
            </h2>
            <div id="crypto-selector-content" class="card-content">
            <div class="crypto-selector">
                <div class="search-container">
                    <input 
                        type="text" 
                        id="cryptoSearch" 
                        placeholder="Enter symbol (e.g., BTC, ETH, SOL, ADA)..." 
                        style="flex: 1; padding: 12px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; transition: border 0.3s;"
                        onkeypress="if(event.key === 'Enter') analyzeCrypto()"
                    />
                    <button class="button" onclick="analyzeCrypto()" style="margin-left: 10px; padding: 12px 24px;">
                        üîç Analyze
                    </button>
                </div>

                <!-- AI Model Selector -->
                <div style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
                        ü§ñ AI Analysis Model:
                    </label>
                    <select id="aiModelSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">
                        <option value="local">üíª Local Analysis (Free - No AI)</option>
                        <option value="openai">ü§ñ OpenAI GPT-4o-mini (Cheapest AI - $0.0007)</option>
                        <option value="anthropic" selected>üß† Anthropic Claude Haiku (Fast - $0.0014)</option>
                        <option value="both">üî¨ Both Models - Consensus ($0.0021)</option>
                    </select>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">
                        <strong>Estimated Cost per Analysis:</strong> Local = $0 | OpenAI = $0.0007 | Anthropic = $0.0014 | Both = $0.0021
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <p style="color: #6b7280; margin-bottom: 10px; font-size: 14px;">Or choose from popular cryptocurrencies:</p>
                    <div class="popular-coins">
                        <button class="coin-button" onclick="selectCrypto('BTC')">
                            <span class="coin-icon">‚Çø</span>
                            <div>
                                <div class="coin-name">Bitcoin</div>
                                <div class="coin-symbol">BTC</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('ETH')">
                            <span class="coin-icon">Œû</span>
                            <div>
                                <div class="coin-name">Ethereum</div>
                                <div class="coin-symbol">ETH</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('SOL')">
                            <span class="coin-icon">‚óé</span>
                            <div>
                                <div class="coin-name">Solana</div>
                                <div class="coin-symbol">SOL</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('ADA')">
                            <span class="coin-icon">‚Ç≥</span>
                            <div>
                                <div class="coin-name">Cardano</div>
                                <div class="coin-symbol">ADA</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('AVAX')">
                            <span class="coin-icon">‚ñ≤</span>
                            <div>
                                <div class="coin-name">Avalanche</div>
                                <div class="coin-symbol">AVAX</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('DOT')">
                            <span class="coin-icon">‚óè</span>
                            <div>
                                <div class="coin-name">Polkadot</div>
                                <div class="coin-symbol">DOT</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('MATIC')">
                            <span class="coin-icon">‚¨°</span>
                            <div>
                                <div class="coin-name">Polygon</div>
                                <div class="coin-symbol">MATIC</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('LINK')">
                            <span class="coin-icon">‚¨¢</span>
                            <div>
                                <div class="coin-name">Chainlink</div>
                                <div class="coin-symbol">LINK</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Result Display -->
            <div id="analysisResult" style="display: none; margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="analysisTitle" style="margin: 0; color: #667eea;">Analysis Results</h3>
                    <button onclick="closeAnalysis()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6b7280;">√ó</button>
                </div>
                <div id="analysisContent" style="margin-top: 15px;"></div>
            </div>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="card">
            <h2 onclick="toggleCardCollapse('recommendations-content')">
                <span>ü§ñ AI Recommendations</span>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="last-analysis-time" style="color: #666; font-size: 13px;"></span>
                    <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
                </div>
            </h2>
            <div id="recommendations-content" class="card-content">
                <div id="recommendations-list" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Discovery Dashboard -->
        <div class="card" style="margin-bottom: 30px;">
            <h2 onclick="toggleCardCollapse('discovery-content')">
                <span>üîç Discovered Opportunities</span>
                <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
            </h2>
            <div id="discovery-content" class="card-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="discoveryUniverseSelect" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" onchange="saveDiscoverySettings()">
                        <option value="top10">Top 10</option>
                        <option value="top25">Top 25</option>
                        <option value="top50">Top 50</option>
                        <option value="top100">Top 100</option>
                    </select>
                    <select id="discoveryStrategySelect" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" onchange="saveDiscoverySettings()">
                        <option value="conservative">üõ°Ô∏è Conservative</option>
                        <option value="moderate">‚öñÔ∏è Moderate</option>
                        <option value="aggressive">üöÄ Aggressive</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #6b7280; cursor: pointer;">
                        <input type="checkbox" id="forceRefreshCheckbox" style="cursor: pointer;">
                        <span>Force Refresh</span>
                    </label>
                    <button class="button" onclick="runDiscovery()" id="discoveryBtn">
                        üöÄ Run Discovery
                    </button>
                </div>
            </div>
            
            <!-- Last Discovery Info -->
            <div id="discovery-info" style="display: none; margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px; font-size: 13px; color: #6b7280;">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <span>üìÖ <strong>Last Run:</strong> <span id="discovery-timestamp">Never</span></span>
                    <span>‚è±Ô∏è <strong>Execution Time:</strong> <span id="discovery-execution-time">-</span></span>
                    <span>üíæ <strong>Cache Used:</strong> <span id="discovery-cache-status">-</span></span>
                </div>
            </div>
            
            <div id="discovery-status" style="display: none; margin-bottom: 15px; padding: 12px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                <div class="spinner" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 10px;"></div>
                <span id="discovery-message">Scanning markets...</span>
            </div>

            <!-- Analysis Log (Thinking Process) -->
            <div id="analysis-log-container" style="display: none; margin-bottom: 15px; border: 1px solid #e5e7eb; border-radius: 6px; background: #fafafa;">
                <div onclick="toggleAnalysisLog()" style="padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; border-radius: 6px 6px 0 0;">
                    <div>
                        <strong style="color: #374151;">üî¨ Analysis Log</strong>
                        <span id="log-summary" style="margin-left: 10px; color: #6b7280; font-size: 14px;"></span>
                    </div>
                    <span id="log-toggle" style="color: #6b7280; font-size: 20px;">‚ñº</span>
                </div>
                <div id="analysis-log-content" style="max-height: 400px; overflow-y: auto; display: none;">
                    <!-- Log entries will be added here -->
                </div>
            </div>
            
            <div id="discoveries-list">
                <p style="color: #6b7280; text-align: center; padding: 20px;">
                    Click "Run Discovery" to find trading opportunities based on your coin universe setting.
                </p>
            </div>
            </div>
        </div>

        <!-- Manual Trading Widget -->
        <div class="card" style="margin-bottom: 30px;">
            <h2 onclick="toggleCardCollapse('manual-trading-content')">
                <span>üí∞ Buy Cryptocurrency</span>
                <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
            </h2>
            <div id="manual-trading-content" class="card-content">
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">
                Purchase any cryptocurrency manually. Use "Current Holdings" below to sell existing positions.
            </p>
            
            <div style="display: grid; gap: 12px;">
                <!-- Symbol and Amount in one row -->
                <div style="display: grid; grid-template-columns: 140px 1fr auto; gap: 10px; align-items: end;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; color: #374151; font-size: 13px;">Symbol</label>
                        <input 
                            type="text" 
                            id="manualTradeSymbol" 
                            placeholder="e.g., ZEC"
                            style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                            onkeyup="this.value = this.value.toUpperCase()"
                        >
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; color: #374151; font-size: 13px;">Amount</label>
                        <input 
                            type="number" 
                            id="manualTradeQuantity" 
                            placeholder="Enter amount"
                            step="0.00000001"
                            min="0"
                            style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                        >
                    </div>
                    <select 
                        id="quantityType" 
                        onchange="updateQuantityPlaceholder()"
                        style="padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 130px;">
                        <option value="usd">USD Amount</option>
                        <option value="units">Units</option>
                        <option value="percent">% of Portfolio</option>
                    </select>
                </div>
                <div id="quantityHelper" style="font-size: 12px; color: #6b7280; margin-top: -8px;"></div>

                <!-- Optional: Stop Loss & Take Profit -->
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="addStopLoss" onchange="toggleAdvancedOptions()" style="cursor: pointer;">
                        <span style="font-weight: 600; color: #374151;">Add Stop-Loss & Take-Profit</span>
                    </label>
                    <div id="advancedOptions" style="display: none; margin-top: 10px; padding: 15px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 14px; font-weight: 500; color: #374151; display: block; margin-bottom: 5px;">
                                üõë Stop-Loss Price ($)
                            </label>
                            <input 
                                type="number" 
                                id="stopLossPrice" 
                                step="0.01" 
                                min="0"
                                placeholder="Auto-sell if price drops to..."
                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="font-size: 14px; font-weight: 500; color: #374151; display: block; margin-bottom: 5px;">
                                üéØ Take-Profit Price ($)
                            </label>
                            <input 
                                type="number" 
                                id="takeProfitPrice" 
                                step="0.01" 
                                min="0"
                                placeholder="Auto-sell if price reaches..."
                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <!-- Preview Button -->
                <div>
                    <button 
                        class="button" 
                        onclick="previewTrade()"
                        style="width: 100%; background: #667eea;">
                        üëÅÔ∏è Preview Trade
                    </button>
                </div>

                <!-- Trade Preview & Execute Area -->
                <div id="tradePreviewArea" style="display: none;"></div>
            </div>
            </div>
        </div>

        <!-- Portfolio Overview -->
        <div class="grid">
            <div class="card">
                <h2 onclick="toggleCardCollapse('portfolio-content')">
                    <span>Portfolio Overview</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="button refresh-btn" onclick="event.stopPropagation(); loadPortfolio();">‚Üª Refresh</button>
                        <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
                    </div>
                </h2>
                <div id="portfolio-content" class="card-content">
                    <div id="portfolio-metrics" class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2 onclick="toggleCardCollapse('performance-content')">
                    <span>Performance Metrics</span>
                    <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
                </h2>
                <div id="performance-content" class="card-content">
                    <div id="performance-metrics" class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2 onclick="toggleCardCollapse('risk-content')">
                    <span>Risk Exposure</span>
                    <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
                </h2>
                <div id="risk-content" class="card-content">
                    <div id="risk-metrics" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Current Holdings (Full Width) -->
        <div class="card">
            <h2 onclick="toggleCardCollapse('holdings-content')">
                <span>üíº Current Holdings</span>
                <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
            </h2>
            <div id="holdings-content" class="card-content">
                <div id="holdings-list" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Portfolio Value Chart -->
        <div class="card">
            <h2 onclick="toggleCardCollapse('chart-content')">
                <span>üìà Portfolio Value Over Time</span>
                <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
            </h2>
            <div id="chart-content" class="card-content">
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Trade History -->
        <div class="card">
            <h2 onclick="toggleCardCollapse('trades-content')">
                <span>Recent Trades</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="button refresh-btn" onclick="event.stopPropagation(); loadTrades();">‚Üª Refresh</button>
                    <button class="collapse-btn" title="Collapse/Expand">‚ñº</button>
                </div>
            </h2>
            <div id="trades-content" class="card-content">
                <div id="trades-list" class="loading">Loading...</div>
            </div>
        </div>

    </div>

    <script>


        // Run AI analysis now (force recommendation generation)
        async function runAIAnalysisNow() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                // Disable button and show loading
                button.disabled = true;
                button.textContent = '‚è≥ Running Analysis...';
                button.style.opacity = '0.6';
                
                // Trigger recommendation job via API
                const response = await fetch(`${API_BASE}/recommendations/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maxBuy: 5, maxSell: 5 })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to trigger AI analysis');
                }
                
                const result = await response.json();
                
                // Check if recommendations were generated
                const hasRecommendations = result.recommendations && result.recommendations.length > 0;
                
                if (hasRecommendations) {
                    // Show success message with results coming
                    document.getElementById('recommendations-list').innerHTML = `
                        <div style="padding: 20px; text-align: center; background: #d1fae5; border-radius: 6px; border: 1px solid #10b981;">
                            <div style="color: #065f46; font-weight: 600; margin-bottom: 8px;">‚úÖ Analysis Complete!</div>
                            <p style="color: #047857; margin-bottom: 10px; font-size: 14px;">
                                ${result.message || 'Generated recommendations'}
                            </p>
                            <p style="color: #6b7280; font-size: 13px;">
                                Refreshing to show results...
                            </p>
                        </div>
                    `;
                    
                    // Reload recommendations immediately
                    setTimeout(() => {
                        loadRecommendations();
                    }, 2000); // 2 seconds
                } else {
                    // No recommendations generated
                    document.getElementById('recommendations-list').innerHTML = `
                        <div style="padding: 20px; text-align: center; background: #fef3c7; border-radius: 6px; border: 1px solid #f59e0b;">
                            <div style="color: #92400e; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Analysis Complete</div>
                            <p style="color: #78350f; margin-bottom: 10px; font-size: 14px;">
                                ${result.message || 'No trading opportunities found at this time'}
                            </p>
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 15px;">
                                Current market conditions don't meet the AI's criteria for safe trades.
                            </p>
                            <button 
                                onclick="loadRecommendations()" 
                                class="button" 
                                style="padding: 8px 16px; font-size: 13px;">
                                ‚Üê Back
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Failed to trigger AI analysis:', error);
                
                // Show error
                document.getElementById('recommendations-list').innerHTML = `
                    <div style="padding: 30px; text-align: center; background: #fee2e2; border-radius: 8px; border: 2px solid #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <h3 style="color: #991b1b; margin-bottom: 10px;">Analysis Failed</h3>
                        <p style="color: #7f1d1d; margin-bottom: 20px;">
                            ${error.message}
                        </p>
                        <button 
                            onclick="loadRecommendations()" 
                            class="button" 
                            style="background: #667eea;">
                            ‚Üê Back
                        </button>
                    </div>
                `;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = originalText;
                button.style.opacity = '1';
            }
        }

        // Store last analysis timestamp globally
        // MIGRATED to ui/recommendations.js
        /* let lastAnalysisTimestamp = null;
        function updateLastAnalysisTime(timestamp) { ... }
        function refreshAnalysisTimeDisplay() { ... } */

        // Get color for market indicators
        function getMarketRegimeColor(regime) {
            const colors = {
                'bull': '#10b981',
                'bear': '#ef4444',
                'sideways': '#6b7280',
                'high_volatility': '#f59e0b'
            };
            return colors[regime.toLowerCase()] || '#6b7280';
        }

        function getRiskSentimentColor(sentiment) {
            const colors = {
                'risk-on': '#10b981',
                'risk-off': '#ef4444',
                'neutral': '#6b7280'
            };
            return colors[sentiment.toLowerCase()] || '#6b7280';
        }

        function getVIXColor(vix) {
            if (vix < 15) return '#10b981'; // Low fear
            if (vix < 20) return '#6b7280'; // Normal
            if (vix < 30) return '#f59e0b'; // Elevated
            return '#ef4444'; // High panic
        }

        // Load market context
        async function loadMarketContext() {
            try {
                const response = await fetch(`${API_BASE}/market-context`);
                const data = await response.json();

                const regimeColor = getMarketRegimeColor(data.context.marketRegime);
                const sentimentColor = getRiskSentimentColor(data.context.riskSentiment);
                const vixColor = getVIXColor(data.context.traditionalMarkets.vix);

                // Detailed view for modal
                const modalHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${regimeColor};">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">Market Regime</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${regimeColor};">
                                ${data.context.marketRegime.toUpperCase()}
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${sentimentColor};">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">Risk Sentiment</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${sentimentColor};">
                                ${data.context.riskSentiment.toUpperCase()}
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">BTC Dominance</div>
                            <div style="font-size: 20px; font-weight: 700; color: #1f2937;">
                                ${data.context.btcDominance.toFixed(2)}%
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${vixColor};">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">VIX (Fear Index)</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${vixColor};">
                                ${data.context.traditionalMarkets.vix.toFixed(2)}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; font-size: 13px; color: #6b7280;">
                        <strong>üí° Interpretation:</strong> 
                        ${data.context.marketRegime === 'bull' ? 'üìà Bull market - favorable for long positions.' : ''}
                        ${data.context.marketRegime === 'bear' ? 'üìâ Bear market - consider defensive strategies.' : ''}
                        ${data.context.marketRegime === 'sideways' ? '‚ÜîÔ∏è Sideways - range trading or wait for breakout.' : ''}
                        ${data.context.riskSentiment === 'risk-on' ? ' Investors are buying risky assets (good for crypto).' : ''}
                        ${data.context.riskSentiment === 'risk-off' ? ' Investors are seeking safety (caution in crypto).' : ''}
                    </div>
                `;

                // Load into modal
                const modalDiv = document.getElementById('live-market-context');
                if (modalDiv) {
                    modalDiv.innerHTML = modalHTML;
                }

                // Also load into old div if it exists (backwards compatibility)
                const oldDiv = document.getElementById('market-context');
                if (oldDiv) {
                    const contextHTML = `
                        <div class="metric">
                            <span class="metric-label">BTC Dominance</span>
                            <span class="metric-value">${data.context.btcDominance.toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Market Regime</span>
                            <span class="metric-value" style="color: ${regimeColor};">${data.context.marketRegime.toUpperCase()}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Risk Sentiment</span>
                            <span class="metric-value" style="color: ${sentimentColor};">${data.context.riskSentiment.toUpperCase()}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">VIX</span>
                            <span class="metric-value" style="color: ${vixColor};">${data.context.traditionalMarkets.vix.toFixed(2)}</span>
                        </div>
                    `;
                    oldDiv.innerHTML = contextHTML;
                }
            } catch (error) {
                console.error('Failed to load market context:', error);
            }
        }

        // Collapse/Expand card functionality - NOW IN cards.js (exposed via main.js window.toggleCardCollapse)
        // function toggleCardCollapse(cardId) { ... }
        // function initializeCardStates() { ... }

        // Load all data on page load
        // NOTE: Portfolio, Trades, Recommendations, Performance, Risk, Chart, Discovery are now handled by main.js modules
        window.addEventListener('DOMContentLoaded', () => {
            // Still in inline script - not yet migrated:
            loadMarketContext();
        });

        // Modal control functions - NOW IN modals.js (exposed via main.js window.openInfoModal)
        // function openInfoModal() { ... }
        // function closeInfoModal() { ... }

        // ===================================================================
        // MIGRATED TO ui/analysis.js:
        // - selectCrypto() ‚Üí ui/analysis.js
        // - analyzeCrypto() ‚Üí ui/analysis.js
        // - createCandlestickChart() ‚Üí ui/analysis.js
        // - formatAnalysisResults() ‚Üí ui/analysis.js
        // - closeAnalysis() ‚Üí ui/analysis.js
        // - switchTab() ‚Üí ui/modals.js
        // (Code removed - see ui/analysis.js for implementation)
        // ===================================================================

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target === modal) {
                closeInfoModal();
            }
        });
    </script>

    <!-- Information Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° Trading Guide & Information</h2>
                <button class="close-button" onclick="closeInfoModal()">√ó</button>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-button active" onclick="switchTab('updates')">‚ú® What's New</button>
                <button class="tab-button" onclick="switchTab('indicators')">üìä Market Indicators</button>
                <button class="tab-button" onclick="switchTab('trading')">üí∞ Trading Tips</button>
                <button class="tab-button" onclick="switchTab('risk')">üõ°Ô∏è Risk Management</button>
                <button class="tab-button" onclick="switchTab('platform')">üöÄ Platform Guide</button>
            </div>
            
            <div class="modal-body">
                <!-- What's New Tab -->
                <div id="updates" class="tab-content active">
                    <div class="info-section">
                        <h3>üéâ Latest Updates - October 10, 2025</h3>
                        
                        <div class="success-box" style="margin-bottom: 20px;">
                            <strong>üõ°Ô∏è Automatic Protection Execution - NEW!</strong><br>
                            Setting stop loss or take profit now auto-executes when levels are reached.
                        </div>

                        <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">üîê How Protection Auto-Execution Works</h4>
                            <p style="margin-bottom: 10px;"><strong>Setting a protection level = Pre-authorization to sell</strong></p>
                            <ul style="margin-left: 20px;">
                                <li>‚úÖ When you set a <strong>stop loss</strong> or <strong>take profit</strong> level, you're giving permission</li>
                                <li>‚úÖ The system monitors prices every 5 minutes</li>
                                <li>‚úÖ When your level is reached, it <strong>automatically executes</strong> the sell</li>
                                <li>‚úÖ No manual approval needed - you already decided when you set the level</li>
                                <li>‚úÖ Trade history shows it as "üõ°Ô∏è Stop Loss" or "üéØ Take Profit"</li>
                            </ul>
                            <p style="margin-top: 10px; color: #1e40af;"><strong>üí° Think of it like:</strong> Placing a limit order on an exchange. You've already made the decision - execution is just fulfillment.</p>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #b45309;">üéØ Exit Strategies - NEW!</h4>
                            <p style="margin-bottom: 10px;"><strong>Choose how your positions are closed when take profit is reached</strong></p>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 4px;">
                                <strong style="color: #10b981;">üì§ Full Exit (Default)</strong>
                                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                                    <li>Sells 100% of position when level hit</li>
                                    <li>Simple, clear, locks in all profits</li>
                                    <li><strong>Best for:</strong> Conservative traders, clear targets</li>
                                </ul>
                            </div>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 4px;">
                                <strong style="color: #f59e0b;">üìä Ladder Exit</strong>
                                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                                    <li>Sells 50% each time level is hit</li>
                                    <li>Lets winners run, reduces FOMO</li>
                                    <li><strong>Best for:</strong> Strong trends, high conviction trades</li>
                                    <li><strong>Example:</strong> Hit 1: Sell 50% | Hit 2: Sell 25% | Hit 3: Sell 12.5%...</li>
                                </ul>
                            </div>
                            
                            <p style="margin-top: 10px; font-size: 14px; color: #b45309;">
                                <strong>‚ÑπÔ∏è Note:</strong> Stop losses always sell 100% (risk management priority).<br>
                                <strong>üìö Details:</strong> See <code>EXIT_STRATEGIES.md</code> for full comparison and examples.
                            </p>
                            
                            <div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 4px; font-size: 13px; border: 1px solid #10b981;">
                                <strong style="color: #065f46;">‚úÖ How to Set Your Strategy:</strong>
                                <ol style="margin: 8px 0 0 20px; color: #065f46;">
                                    <li>Click the <strong>‚öôÔ∏è Settings</strong> button (top-right)</li>
                                    <li>Find <strong>"Take Profit Strategy"</strong> setting</li>
                                    <li>Choose <strong>Full Exit</strong> or <strong>Ladder Exit</strong></li>
                                    <li>Click <strong>Save Settings</strong></li>
                                </ol>
                                <p style="margin: 8px 0 0 0; color: #065f46;">üí° Changes apply immediately to all future take profit executions!</p>
                            </div>
                        </div>

                        <div class="success-box" style="margin-bottom: 20px;">
                            <strong>üöÄ Discovery Strategy System - LIVE!</strong><br>
                            Choose your risk/reward profile for finding trading opportunities.
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Three Discovery Strategies</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #10b981; margin-bottom: 10px;">üõ°Ô∏è Conservative - Safe & Steady</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Established coins (BTC, ETH, top 10-15)</li>
                                <li><strong>Min Market Cap:</strong> $100M (proven projects)</li>
                                <li><strong>Min Volume:</strong> $10M daily (high liquidity)</li>
                                <li><strong>Score Threshold:</strong> 70/100 (quality filter)</li>
                                <li><strong>Best For:</strong> New traders, risk-averse investors</li>
                                <li><strong>Expected:</strong> 70-80% win rate, 20-50% gains per trade</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #3b82f6; margin-bottom: 10px;">‚öñÔ∏è Moderate - Balanced Growth (Default)</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Mix of established + emerging coins</li>
                                <li><strong>Min Market Cap:</strong> $50M (includes mid-caps)</li>
                                <li><strong>Min Volume:</strong> $2M daily (decent liquidity)</li>
                                <li><strong>Score Threshold:</strong> 65/100 (balanced filter)</li>
                                <li><strong>Best For:</strong> Intermediate traders, balanced portfolios</li>
                                <li><strong>Expected:</strong> 60-70% win rate, 30-100% gains per trade</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #ef4444; margin-bottom: 10px;">üöÄ Aggressive - High Risk/Reward</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Small-caps, emerging trends, moonshots</li>
                                <li><strong>Min Market Cap:</strong> $10M (includes small-caps)</li>
                                <li><strong>Min Volume:</strong> $500K daily (can still trade)</li>
                                <li><strong>Score Threshold:</strong> 60/100 (broader opportunities)</li>
                                <li><strong>Best For:</strong> Experienced traders, speculation</li>
                                <li><strong>Expected:</strong> 40-50% win rate, 100-1000% gains per trade</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üåç Expanded Coin Universe</h3>
                        
                        <p>Now scan up to <strong>top 100 coins</strong> (was limited to top 50):</p>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Top 10 - Blue chips only</li>
                            <li>‚úÖ Top 25 - Quality coins (recommended)</li>
                            <li>‚úÖ Top 50 - Major + large caps</li>
                            <li>‚ú® <strong>NEW: Top 100 - Include mid-caps</strong></li>
                        </ul>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° Pro Tip:</strong> Try "Top 100 + Aggressive" to find hidden gems with strong momentum!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>‚öôÔ∏è How to Use</h3>
                        
                        <p><strong>Quick Access (Discovery Section):</strong></p>
                        <ol style="margin-left: 20px;">
                            <li>Go to "üîç Discovered Opportunities" section</li>
                            <li>Select universe: Top 10/25/50/100</li>
                            <li>Select strategy: Conservative/Moderate/Aggressive</li>
                            <li>Click "üöÄ Run Discovery"</li>
                            <li>See different results based on strategy!</li>
                        </ol>

                        <p style="margin-top: 15px;"><strong>Settings (For Automation):</strong></p>
                        <ol style="margin-left: 20px;">
                            <li>Click ‚öôÔ∏è icon (top-right)</li>
                            <li>Set "Coin Universe" (controls automated discovery)</li>
                            <li>Set "Discovery Strategy" (controls risk profile)</li>
                            <li>Save settings</li>
                            <li>Automated discovery will use your preferences!</li>
                        </ol>
                    </div>

                    <div class="info-section">
                        <h3>üìä Understanding Discovery Scores</h3>
                        
                        <p style="margin-bottom: 15px; color: #6b7280;">
                            The discovery system evaluates coins using multiple scoring metrics (0-100 scale):
                        </p>
                        
                        <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìà Volume Score (0-100)</h4>
                            <p style="margin-bottom: 8px;"><strong>What it measures:</strong> Unusual trading volume activity</p>
                            <ul style="margin-left: 20px;">
                                <li><strong>Formula:</strong> (Volume / Market Cap) ratio normalized</li>
                                <li><strong>Typical range:</strong> 0.01-0.5, above 0.3 is significant</li>
                                <li><strong>Higher score:</strong> More unusual volume spike (potential breakout)</li>
                                <li><strong>Lower score:</strong> Normal/low volume (less momentum)</li>
                            </ul>
                        </div>

                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #065f46;">üöÄ Momentum Score (0-100)</h4>
                            <p style="margin-bottom: 8px;"><strong>What it measures:</strong> Recent price momentum strength</p>
                            <ul style="margin-left: 20px;">
                                <li><strong>Formula:</strong> (24h change √ó 60%) + (7d change √ó 40%)</li>
                                <li><strong>Normalizes:</strong> -10% to +10% price change into 0-100 scale</li>
                                <li><strong>Higher score:</strong> Strong upward momentum</li>
                                <li><strong>Lower score:</strong> Downward or weak momentum</li>
                                <li><strong>50 = neutral:</strong> No significant momentum either direction</li>
                            </ul>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #92400e;">üí¨ Sentiment Score (0-100)</h4>
                            <p style="margin-bottom: 8px;"><strong>What it measures:</strong> Social media and news sentiment</p>
                            <ul style="margin-left: 20px;">
                                <li><strong>Sources:</strong> Reddit mentions + News articles</li>
                                <li><strong>50 = neutral:</strong> Balanced sentiment</li>
                                <li><strong>Above 50:</strong> Bullish sentiment (positive buzz)</li>
                                <li><strong>Below 50:</strong> Bearish sentiment (negative news)</li>
                                <li><strong>Higher score:</strong> More positive community/media coverage</li>
                            </ul>
                        </div>

                        <div class="success-box">
                            <h4 style="margin: 0 0 10px 0;">‚≠ê Composite Score (0-100) - The Main Score</h4>
                            <p style="margin-bottom: 10px;"><strong>This is the final score you see in discovery results.</strong></p>
                            <p style="margin-bottom: 10px;">Weighted combination of all 3 scores:</p>
                            
                            <table class="info-table" style="margin: 10px 0;">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Volume Weight</th>
                                        <th>Momentum Weight</th>
                                        <th>Sentiment Weight</th>
                                        <th>Min Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Conservative</strong></td>
                                        <td>25%</td>
                                        <td>35%</td>
                                        <td>40%</td>
                                        <td>70+</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Moderate</strong></td>
                                        <td>30%</td>
                                        <td>35%</td>
                                        <td>35%</td>
                                        <td>65+</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Aggressive</strong></td>
                                        <td>35%</td>
                                        <td>40%</td>
                                        <td>25%</td>
                                        <td>60+</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <p style="margin-top: 10px;"><strong>üìå Key Insights:</strong></p>
                            <ul style="margin: 5px 0 0 20px;">
                                <li><strong>Conservative:</strong> Trusts sentiment more (safer, proven coins)</li>
                                <li><strong>Moderate:</strong> Balanced approach (best for most users)</li>
                                <li><strong>Aggressive:</strong> Emphasizes volume + momentum (chases pumps)</li>
                                <li>Only coins above the threshold score are shown</li>
                            </ul>
                        </div>

                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° How to Read Scores:</strong><br>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>80-100:</strong> Excellent opportunity (all signals align)</li>
                                <li><strong>70-79:</strong> Good opportunity (strong signals)</li>
                                <li><strong>65-69:</strong> Decent opportunity (mixed signals)</li>
                                <li><strong>60-64:</strong> Marginal (proceed with caution)</li>
                                <li><strong>Below 60:</strong> Filtered out (doesn't meet criteria)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üí∞ Manual Trading Widget - NEW!</h3>
                        
                        <div class="success-box" style="margin-bottom: 15px;">
                            <strong>üéâ Now you can execute trades manually with full control!</strong>
                        </div>
                        
                        <p><strong>Features:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ <strong>Quick Trade Entry:</strong> Buy or sell any cryptocurrency</li>
                            <li>‚úÖ <strong>Flexible Amounts:</strong> Enter quantity in units, USD, or % of portfolio</li>
                            <li>‚úÖ <strong>Trade Preview:</strong> See costs, fees, and slippage before executing</li>
                            <li>‚úÖ <strong>Stop-Loss & Take-Profit:</strong> Set protective orders automatically</li>
                            <li>‚úÖ <strong>Real-time Validation:</strong> Instant feedback on invalid inputs</li>
                            <li>‚úÖ <strong>Auto Portfolio Updates:</strong> Holdings refresh after each trade</li>
                        </ul>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° How to use:</strong> Scroll down to the "üí∞ Manual Trading" section, enter a symbol (e.g., ZEC), choose amount, preview, and execute!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üîß Other Recent Improvements</h3>
                        
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ <strong>Sparkline Charts:</strong> See 48-hour price trends in discovery table</li>
                            <li>‚úÖ <strong>Current Prices:</strong> Live prices with 24h change in discoveries</li>
                            <li>‚úÖ <strong>70+ Altcoins Supported:</strong> Including ZEC, XMR, DASH, and more</li>
                            <li>‚úÖ <strong>Dynamic Coin Discovery:</strong> Auto-finds coin IDs for unknown symbols</li>
                            <li>‚úÖ <strong>Force Refresh:</strong> Bypass cache for fresh data</li>
                            <li>‚úÖ <strong>Execution Tracking:</strong> See when discovery last ran</li>
                            <li>‚úÖ <strong>Coinbase Integration:</strong> Replaced Binance for US compliance</li>
                            <li>‚úÖ <strong>RSS News Feeds:</strong> Unlimited news from 5 sources</li>
                            <li>‚úÖ <strong>Optimized Caching:</strong> 97% reduction in API calls</li>
                            <li>‚úÖ <strong>Free Tier Only:</strong> All APIs use free tiers ($0 cost!)</li>
                        </ul>
                    </div>
                </div>

                <!-- Market Indicators Tab -->
                <div id="indicators" class="tab-content">
                    <!-- Live Market Context -->
                    <div class="info-section" style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 2px solid #3b82f6; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #1e40af;">üåç Live Market Context</h3>
                        <div id="live-market-context" class="loading">Loading current market data...</div>
                    </div>

                    <div class="info-section">
                        <h3>üìà BTC Dominance</h3>
                        <p><strong>Source:</strong> CoinGecko API - Global Market Data</p>
                        <p><strong>What it means:</strong> Bitcoin's market cap as a percentage of total cryptocurrency market cap.</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Market State</th>
                                    <th>What It Means</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>&gt; 60%</strong></td>
                                    <td>High Dominance</td>
                                    <td>Bitcoin leading, altcoins underperforming</td>
                                </tr>
                                <tr>
                                    <td><strong>40-60%</strong></td>
                                    <td>Balanced Market</td>
                                    <td>Healthy distribution between BTC and alts</td>
                                </tr>
                                <tr>
                                    <td><strong>&lt; 40%</strong></td>
                                    <td>"Alt Season"</td>
                                    <td>Altcoins outperforming Bitcoin</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="tip-box">
                            <strong>üí° Trading Signal:</strong> Rising BTC dominance = Money flowing INTO Bitcoin (risk-off behavior). Falling dominance = Money flowing INTO altcoins (risk-on behavior).
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Market Regime</h3>
                        <p><strong>Source:</strong> Custom analysis based on 30-day price movements and volatility</p>
                        <p><strong>How it's calculated:</strong> Analyzes BTC price changes, daily ranges, and trend direction</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Regime</th>
                                    <th>Condition</th>
                                    <th>Strategy</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>BULL üêÇ</strong></td>
                                    <td>Price up &gt;10% in 30 days, low volatility</td>
                                    <td>Long positions, momentum trading</td>
                                </tr>
                                <tr>
                                    <td><strong>BEAR üêª</strong></td>
                                    <td>Price down &gt;10% in 30 days</td>
                                    <td>Defensive, short positions, or cash</td>
                                </tr>
                                <tr>
                                    <td><strong>SIDEWAYS ‚ÜîÔ∏è</strong></td>
                                    <td>Price change &lt;10%, consolidating</td>
                                    <td>Range trading, wait for breakout</td>
                                </tr>
                                <tr>
                                    <td><strong>HIGH_VOLATILITY ‚ö°</strong></td>
                                    <td>Daily range &gt;5%</td>
                                    <td>Reduce positions, tight stop-losses</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="info-section">
                        <h3>üíº Risk Sentiment</h3>
                        <p><strong>Source:</strong> Alpha Vantage - Traditional market indicators (S&P 500, Gold, VIX)</p>
                        <p><strong>Why it matters:</strong> Crypto shows ~40-60% correlation with traditional markets</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Sentiment</th>
                                    <th>Indicators</th>
                                    <th>Impact on Crypto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong style="color: #10b981;">RISK-ON</strong></td>
                                    <td>S&P 500 ‚Üë, VIX ‚Üì, Gold ‚Üì</td>
                                    <td>‚úÖ Positive - Investors buying risky assets</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #ef4444;">RISK-OFF</strong></td>
                                    <td>S&P 500 ‚Üì, VIX ‚Üë, Gold ‚Üë</td>
                                    <td>‚ùå Negative - Investors seeking safety</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #6b7280;">NEUTRAL</strong></td>
                                    <td>Mixed signals</td>
                                    <td>‚ö†Ô∏è Uncertain market direction</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Important:</strong> Risk-off sentiment typically precedes crypto selloffs. Use this as an early warning system.
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìâ VIX (Volatility Index)</h3>
                        <p><strong>Source:</strong> Alpha Vantage - CBOE Volatility Index (^VIX)</p>
                        <p><strong>What it is:</strong> Measures expected 30-day volatility in the S&P 500</p>
                        <p><strong>Nickname:</strong> "The Fear Index"</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>VIX Level</th>
                                    <th>Market State</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>&lt; 15</strong></td>
                                    <td>üòå Calm, Low Fear</td>
                                    <td>Normal trading operations</td>
                                </tr>
                                <tr>
                                    <td><strong>15-20</strong></td>
                                    <td>üòê Normal Volatility</td>
                                    <td>Monitor market closely</td>
                                </tr>
                                <tr>
                                    <td><strong>20-30</strong></td>
                                    <td>üò∞ Elevated Fear</td>
                                    <td>Reduce position sizes</td>
                                </tr>
                                <tr>
                                    <td><strong>&gt; 30</strong></td>
                                    <td>üò± High Panic</td>
                                    <td>üö® High risk - defensive positions</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="warning-box">
                            <strong>üö® Current Alert:</strong> If VIX > 30, expect increased crypto volatility and potential selloffs. Consider reducing leverage and tightening stop-losses.
                        </div>
                    </div>
                </div>

                <!-- Trading Tips Tab -->
                <div id="trading" class="tab-content">
                    <div class="info-section">
                        <h3>üéØ Core Trading Principles</h3>
                        
                        <div class="success-box">
                            <strong>‚úÖ DO:</strong>
                            <ul>
                                <li>Trade with a plan - know your entry, exit, and stop-loss before trading</li>
                                <li>Use position sizing - never risk more than 1-2% of capital per trade</li>
                                <li>Follow the trend - "The trend is your friend until it ends"</li>
                                <li>Use technical AND fundamental analysis together</li>
                                <li>Keep a trading journal - track what works and what doesn't</li>
                                <li>Wait for confirmation - don't chase pumps</li>
                            </ul>
                        </div>

                        <div class="warning-box">
                            <strong>‚ùå DON'T:</strong>
                            <ul>
                                <li>Trade based on emotions (FOMO, panic)</li>
                                <li>Risk money you can't afford to lose</li>
                                <li>Ignore stop-losses - they're your safety net</li>
                                <li>Overtrade - quality over quantity</li>
                                <li>Average down on losing positions</li>
                                <li>Trade without understanding why</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìä Technical Analysis Tips</h3>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Indicator</th>
                                    <th>Best Use</th>
                                    <th>Signal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>RSI (14)</strong></td>
                                    <td>Overbought/Oversold</td>
                                    <td>&gt;70 = Overbought, &lt;30 = Oversold</td>
                                </tr>
                                <tr>
                                    <td><strong>MACD</strong></td>
                                    <td>Trend & Momentum</td>
                                    <td>Line crosses = Trend changes</td>
                                </tr>
                                <tr>
                                    <td><strong>Bollinger Bands</strong></td>
                                    <td>Volatility & Breakouts</td>
                                    <td>Price at edges = Reversal or breakout</td>
                                </tr>
                                <tr>
                                    <td><strong>Volume</strong></td>
                                    <td>Confirm Trends</td>
                                    <td>Rising volume = Strong move</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="tip-box">
                            <strong>üí° Pro Tip:</strong> No single indicator is perfect. Use multiple indicators together for confirmation. If RSI, MACD, and trend all align - that's a strong signal!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Entry & Exit Strategies</h3>
                        
                        <p><strong>Best Entry Signals:</strong></p>
                        <ul>
                            <li>‚úÖ Price bounces off support + RSI oversold</li>
                            <li>‚úÖ MACD crossover + bullish candle pattern</li>
                            <li>‚úÖ Breakout above resistance with high volume</li>
                            <li>‚úÖ Positive market regime + risk-on sentiment</li>
                        </ul>

                        <p><strong>Exit Signals (Protect Profits):</strong></p>
                        <ul>
                            <li>üéØ Take partial profits at +20%, +50%, +100%</li>
                            <li>üéØ Trail stop-loss as price rises</li>
                            <li>üéØ Exit when indicators turn bearish</li>
                            <li>üéØ Exit when market regime changes to bearish</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>üïØÔ∏è About Candlestick Patterns</h3>
                        
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #92400e;">‚ö†Ô∏è Why This System Doesn't Use Candlestick Patterns</h4>
                            <p style="margin-bottom: 10px;"><strong>Candlestick patterns (hammers, engulfing, doji, etc.) are popular but scientifically weak predictors:</strong></p>
                            
                            <ul style="margin: 10px 0 10px 20px;">
                                <li><strong>Low Accuracy:</strong> Most patterns have only 50-55% win rate (barely better than random)</li>
                                <li><strong>Confirmation Bias:</strong> Traders remember successful patterns, forget failed ones</li>
                                <li><strong>No Statistical Edge:</strong> Academic research shows weak to no predictive power in isolation</li>
                                <li><strong>Self-Fulfilling:</strong> Work temporarily when many traders act on same pattern, then fade</li>
                                <li><strong>Data Mining:</strong> Patterns discovered through backtesting, not predictive theory</li>
                            </ul>
                        </div>

                        <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìä Research Findings</h4>
                            <table class="info-table" style="margin-top: 10px;">
                                <thead>
                                    <tr>
                                        <th>Signal Type</th>
                                        <th>Typical Win Rate</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Candlestick Pattern Alone</td>
                                        <td>51-54%</td>
                                        <td style="color: #ef4444;">‚ùå Weak</td>
                                    </tr>
                                    <tr>
                                        <td>Pattern + Volume</td>
                                        <td>55-58%</td>
                                        <td style="color: #f59e0b;">‚ö†Ô∏è Marginal</td>
                                    </tr>
                                    <tr>
                                        <td>RSI Divergence</td>
                                        <td>60-65%</td>
                                        <td style="color: #10b981;">‚úÖ Better</td>
                                    </tr>
                                    <tr>
                                        <td>Trend Following</td>
                                        <td>60-70%</td>
                                        <td style="color: #10b981;">‚úÖ Strong</td>
                                    </tr>
                                    <tr>
                                        <td>Following BTC (High Dominance)</td>
                                        <td>65-75%</td>
                                        <td style="color: #10b981;">‚úÖ Strongest</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="success-box">
                            <h4 style="margin: 0 0 10px 0;">‚úÖ What This System Uses Instead</h4>
                            <p><strong>Our AI analysis focuses on statistically stronger signals:</strong></p>
                            <ul style="margin: 10px 0 0 20px;">
                                <li><strong>Technical Indicators:</strong> RSI, MACD, Bollinger Bands (quantitative, backtested)</li>
                                <li><strong>Market Structure:</strong> Support/resistance, trend direction, higher highs/lower lows</li>
                                <li><strong>Volume Analysis:</strong> Confirms strength of moves, detects accumulation/distribution</li>
                                <li><strong>Market Context:</strong> BTC dominance, risk sentiment, market regime (macro factors)</li>
                                <li><strong>Sentiment Analysis:</strong> Social media trends, news sentiment from multiple sources</li>
                            </ul>
                            <p style="margin-top: 10px;"><strong>Result:</strong> Higher accuracy by focusing on proven statistical edges, not pattern recognition.</p>
                        </div>

                        <div class="tip-box">
                            <strong>üí° For Education:</strong> It's still valuable to learn major candlestick patterns for market literacy - just don't trade on them alone. Use them as <strong>descriptive language</strong> for price action, not as predictive signals. If you see a pattern, ask: "What does volume say? Where is support/resistance? What's the trend?" - never trade the pattern in isolation.
                        </div>
                    </div>
                </div>

                <!-- Risk Management Tab -->
                <div id="risk" class="tab-content">
                    <div class="info-section">
                        <h3>üõ°Ô∏è Position Sizing Formula</h3>
                        
                        <div class="success-box">
                            <strong>Safe Position Size =</strong><br>
                            (Account Size √ó Risk %) √∑ (Entry Price - Stop Loss Price)<br><br>
                            <strong>Example:</strong><br>
                            - Account: $10,000<br>
                            - Risk per trade: 2% = $200<br>
                            - Entry: $50,000<br>
                            - Stop Loss: $48,000<br>
                            - Position Size: $200 √∑ $2,000 = 0.1 BTC
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Golden Rules:</strong>
                            <ul>
                                <li>Never risk more than 2% per trade</li>
                                <li>Maximum 20% total portfolio risk at once</li>
                                <li>Larger position = Tighter stop-loss</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìâ Stop-Loss Strategies</h3>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>When to Use</th>
                                    <th>How to Set</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Fixed %</strong></td>
                                    <td>Volatile assets</td>
                                    <td>5-10% below entry</td>
                                </tr>
                                <tr>
                                    <td><strong>Support Level</strong></td>
                                    <td>Trending markets</td>
                                    <td>Just below key support</td>
                                </tr>
                                <tr>
                                    <td><strong>ATR-Based</strong></td>
                                    <td>Any market</td>
                                    <td>2-3√ó ATR below entry</td>
                                </tr>
                                <tr>
                                    <td><strong>Trailing</strong></td>
                                    <td>Strong trends</td>
                                    <td>Move up as price rises</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="info-section">
                        <h3>‚öñÔ∏è Risk/Reward Ratios</h3>
                        
                        <div class="tip-box">
                            <strong>üí° Minimum Ratios:</strong><br>
                            - Conservative: 1:3 (Risk $100 to make $300)<br>
                            - Moderate: 1:2 (Risk $100 to make $200)<br>
                            - Never take trades below 1:1.5 ratio<br><br>
                            
                            <strong>Why it matters:</strong> With a 1:3 ratio, you only need 33% win rate to be profitable!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üö® When to Reduce Risk</h3>
                        <ul>
                            <li>‚ùå VIX above 30 - High market fear</li>
                            <li>‚ùå Market regime = HIGH_VOLATILITY</li>
                            <li>‚ùå Risk sentiment = RISK-OFF</li>
                            <li>‚ùå Multiple losing trades in a row</li>
                            <li>‚ùå BTC dominance rapidly changing</li>
                            <li>‚ùå Low volume / low liquidity periods</li>
                        </ul>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Defense Mode:</strong> When 2+ risk factors are present, reduce position sizes by 50% or move to cash. Preservation of capital is the #1 priority.
                        </div>
                    </div>
                </div>

                <!-- Platform Guide Tab -->
                <div id="platform" class="tab-content">
                    <div class="info-section">
                        <h3>üéÆ How to Use This Platform</h3>
                        
                        <p><strong>Current Features:</strong></p>
                        <ul>
                            <li>‚úÖ Real-time market data from multiple sources</li>
                            <li>‚úÖ AI-powered trade recommendations</li>
                            <li>‚úÖ Portfolio tracking ($10,000 starting capital)</li>
                            <li>‚úÖ Technical indicator analysis</li>
                            <li>‚úÖ Sentiment analysis (Reddit + News)</li>
                            <li>‚úÖ Market context monitoring</li>
                            <li>‚úÖ Paper trading (virtual money only)</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>üìä Dashboard Sections Explained</h3>
                        
                        <p><strong>Portfolio Overview:</strong> Your virtual account balance, positions, and returns</p>
                        
                        <p><strong>Performance Metrics:</strong></p>
                        <ul>
                            <li><strong>Sharpe Ratio:</strong> Risk-adjusted returns (&gt;1 is good)</li>
                            <li><strong>Max Drawdown:</strong> Largest peak-to-trough decline</li>
                            <li><strong>Win Rate:</strong> Percentage of profitable trades</li>
                        </ul>

                        <p><strong>Market Context:</strong> Real-time macro indicators affecting crypto</p>
                        
                        <p><strong>AI Recommendations:</strong> Machine learning-powered trade suggestions</p>
                    </div>

                    <div class="info-section">
                        <h3>üîÑ Data Sources</h3>
                        
                        <p style="margin-bottom: 15px; color: #6b7280;">
                            <strong>All data sources use free tiers</strong> - No API costs! Optimized with aggressive caching to stay within rate limits.
                        </p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Data Type</th>
                                    <th>Rate Limit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ü™ô Coinbase</strong></td>
                                    <td>Candlesticks, OHLC, Order Book, Real-time Prices</td>
                                    <td>10,000/hour</td>
                                </tr>
                                <tr>
                                    <td><strong>ü¶é CoinGecko</strong></td>
                                    <td>Market Cap, Dominance, Coin Rankings</td>
                                    <td>50/min</td>
                                </tr>
                                <tr>
                                    <td><strong>üì∞ CryptoCompare</strong></td>
                                    <td>News Articles, Sentiment (Votes)</td>
                                    <td>3,000/month</td>
                                </tr>
                                <tr>
                                    <td><strong>üì° RSS Feeds</strong></td>
                                    <td>News (CoinDesk, CoinTelegraph, Decrypt, Bitcoin Magazine, The Block)</td>
                                    <td>Unlimited</td>
                                </tr>
                                <tr>
                                    <td><strong>üó£Ô∏è Reddit</strong></td>
                                    <td>Social Sentiment, Community Discussion</td>
                                    <td>60/min</td>
                                </tr>
                                <tr>
                                    <td><strong>üìà Alpha Vantage</strong></td>
                                    <td>Traditional Markets (S&P 500, VIX, Gold)</td>
                                    <td>25/day</td>
                                </tr>
                                <tr>
                                    <td><strong>ü§ñ OpenAI/Anthropic</strong></td>
                                    <td>AI Analysis & Trade Recommendations</td>
                                    <td>On-demand</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° Recent Updates:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>Replaced Binance ‚Üí Coinbase</strong> - More reliable US access</li>
                                <li><strong>Added CryptoCompare News</strong> - Vote-based sentiment analysis</li>
                                <li><strong>Added 5 RSS feeds</strong> - Unlimited news coverage</li>
                                <li><strong>Optimized caching</strong> - 97% reduction in API calls</li>
                                <li><strong>Disabled CryptoPanic</strong> - Exceeded free tier, replaced with better sources</li>
                            </ul>
                        </div>
                        
                        <div class="success-box" style="margin-top: 15px;">
                            <strong>‚úÖ Sentiment Analysis Method:</strong><br>
                            Uses <strong>lexicon-based analysis</strong> (not AI) with crypto-specific keywords:
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>Speed:</strong> &lt;1ms per article (vs 1-3s for AI)</li>
                                <li><strong>Cost:</strong> $0 (vs $0.075 per 50 articles with GPT-4)</li>
                                <li><strong>Sources weighted:</strong> CoinDesk (1.0), CoinTelegraph (0.95), etc.</li>
                                <li><strong>Multi-source:</strong> Title (60%) + Content (40%) + Votes</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>ü§ñ AI Analysis Data Inputs</h3>
                        
                        <p style="margin-bottom: 15px; color: #6b7280;">
                            When you analyze a cryptocurrency, the AI models receive comprehensive data to make informed recommendations:
                        </p>
                        
                        <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìä Technical Data</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Symbol & Current Price:</strong> Real-time market price</li>
                                <li><strong>Candlestick Data:</strong> Last 100 hours of OHLC (Open, High, Low, Close) data</li>
                                <li><strong>Technical Indicators:</strong>
                                    <ul style="margin-left: 20px; margin-top: 5px;">
                                        <li>RSI (14-period) - Momentum oscillator</li>
                                        <li>MACD - Trend following indicator</li>
                                        <li>Bollinger Bands - Volatility indicator</li>
                                        <li>Moving Averages - Trend identification</li>
                                        <li>Additional momentum indicators</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>

                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #065f46;">üí¨ Sentiment Data</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Reddit Mentions:</strong> Up to 50 recent posts from crypto subreddits</li>
                                <li><strong>News Articles:</strong> Up to 20 recent news headlines from crypto news sources</li>
                                <li><strong>Aggregated Sentiment Scores:</strong> Combined sentiment analysis from all sources</li>
                                <li><strong>Mention Volume:</strong> How frequently the coin is being discussed</li>
                            </ul>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #92400e;">üåç Market Context</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>BTC Dominance:</strong> Bitcoin's percentage of total crypto market cap</li>
                                <li><strong>Market Regime:</strong> Bull, Bear, Sideways, or High Volatility</li>
                                <li><strong>Risk Sentiment:</strong> Risk-On (growth mode) or Risk-Off (defensive mode)</li>
                                <li><strong>VIX (Fear Index):</strong> Traditional market volatility indicator</li>
                                <li><strong>Traditional Markets:</strong> S&P 500 correlation and macro trends</li>
                            </ul>
                        </div>

                        <div class="success-box">
                            <strong>üß† AI Processing:</strong><br>
                            The AI models (OpenAI GPT-4o-mini and Anthropic Claude Haiku) analyze all this data together to provide:
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>Action:</strong> BUY, SELL, or HOLD recommendation</li>
                                <li><strong>Confidence Level:</strong> 0-100% based on signal strength</li>
                                <li><strong>Entry/Exit Prices:</strong> Specific price targets</li>
                                <li><strong>Risk Assessment:</strong> LOW, MEDIUM, or HIGH risk rating</li>
                                <li><strong>Reasoning:</strong> Bull case, bear case, and conclusion</li>
                            </ul>
                        </div>

                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° Multi-Model Consensus:</strong><br>
                            When you select "Both Models", both OpenAI and Anthropic analyze the same data independently. You'll see both analyses side-by-side, allowing you to:
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li>Compare different AI perspectives</li>
                                <li>Identify where models agree (higher confidence)</li>
                                <li>Spot disagreements (proceed with caution)</li>
                                <li>Get a combined consensus recommendation</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>‚ö†Ô∏è Important Disclaimers</h3>
                        
                        <div class="warning-box">
                            <strong>üö® Paper Trading Only:</strong><br>
                            This platform uses VIRTUAL MONEY only. No real cryptocurrency is bought or sold. This is for learning and testing strategies only.
                        </div>

                        <div class="tip-box">
                            <strong>üí° Best Practices:</strong>
                            <ul>
                                <li>Treat virtual money as real - take it seriously</li>
                                <li>Test different strategies</li>
                                <li>Learn from mistakes without financial risk</li>
                                <li>Build confidence before real trading</li>
                                <li>Track your decision-making process</li>
                            </ul>
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Not Financial Advice:</strong><br>
                            This platform provides educational information and analysis tools. All recommendations are for educational purposes only. Always do your own research and consult with financial advisors before making real investment decisions.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Your Settings</h2>
                <button class="close-button" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <!-- Appearance Settings -->
                <div class="info-section">
                    <h3>üé® Appearance</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Theme</h4>
                            <p>Choose between light and dark mode</p>
                        </div>
                        <div class="setting-control">
                            <select id="themeSelect" class="setting-select" onchange="changeTheme(this.value)">
                                <option value="light">‚òÄÔ∏è Light Mode</option>
                                <option value="dark">üåô Dark Mode</option>
                                <option value="auto">üíª Auto (System)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Auto-Trading Settings -->
                <div class="info-section">
                    <h3>ü§ñ Auto-Trading</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Enable Auto-Execution</h4>
                            <p>Automatically execute trades when AI confidence exceeds threshold</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoExecuteToggle" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Confidence Threshold</h4>
                            <p>Minimum AI confidence required for auto-execution</p>
                        </div>
                        <div class="setting-control">
                            <div class="range-slider">
                                <input type="range" id="confidenceThreshold" min="70" max="90" step="5" value="75" oninput="updateConfidenceValue(this.value)" onchange="saveSettings()">
                                <div class="range-value"><span id="confidenceValue">75</span>%</div>
                            </div>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Human-in-the-Loop</h4>
                            <p>Require manual approval before executing trades</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="humanApprovalToggle" checked onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Position Sizing -->
                <div class="info-section">
                    <h3>üí∞ Capital Allocation</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Position Sizing Strategy</h4>
                            <p>How to calculate position size for new trades</p>
                        </div>
                        <div class="setting-control">
                            <select id="positionSizingStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="equal">Equal Weight - Same size for all positions</option>
                                <option value="confidence">Confidence-Based - Size by AI confidence</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Maximum Position Size</h4>
                            <p>Maximum % of portfolio per single position</p>
                        </div>
                        <div class="setting-control">
                            <div class="range-slider">
                                <input type="range" id="maxPositionSize" min="2" max="10" step="1" value="5" oninput="updateMaxPositionValue(this.value)" onchange="saveSettings()">
                                <div class="range-value"><span id="maxPositionValue">5</span>%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exit Strategy -->
                <div class="info-section">
                    <h3>üéØ Exit Strategy</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Take Profit Strategy</h4>
                            <p>How to handle reaching profit targets</p>
                        </div>
                        <div class="setting-control">
                            <select id="takeProfitStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="full">Full Exit - Close entire position at target</option>
                                <option value="partial">Partial Exit - Close 50% at first target</option>
                                <option value="trailing">Trailing Stop - Follow price upward</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Auto Stop-Loss</h4>
                            <p>Automatically exit when stop-loss is hit</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoStopLossToggle" checked onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Market Focus -->
                <div class="info-section">
                    <h3>üéØ Market Focus</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Coin Universe</h4>
                            <p>Which cryptocurrencies to analyze and trade</p>
                        </div>
                        <div class="setting-control">
                            <select id="coinUniverse" class="setting-select" onchange="saveSettings()">
                                <option value="top10">Top 10 - BTC, ETH, BNB, etc.</option>
                                <option value="top25" selected>Top 25 - Quality coins (recommended)</option>
                                <option value="top50">Top 50 - Major coins + large caps</option>
                                <option value="top100">Top 100 - Include mid-caps</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Discovery Strategy</h4>
                            <p>Risk/reward profile for finding opportunities</p>
                        </div>
                        <div class="setting-control">
                            <select id="discoveryStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="conservative">üõ°Ô∏è Conservative - Safe & Steady</option>
                                <option value="moderate" selected>‚öñÔ∏è Moderate - Balanced Growth</option>
                                <option value="aggressive">üöÄ Aggressive - High Risk/Reward</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Analysis Frequency</h4>
                            <p>How often to generate new AI recommendations</p>
                        </div>
                        <div class="setting-control">
                            <select id="analysisFrequency" class="setting-select" onchange="saveSettings()">
                                <option value="1">Every 1 Hour (High cost)</option>
                                <option value="4" selected>Every 4 Hours (Recommended)</option>
                                <option value="8">Every 8 Hours (Low cost)</option>
                                <option value="24">Daily (Minimal cost)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Warning Box -->
                <div class="warning-box" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Auto-Trading Risk Warning:</strong><br>
                    Enabling auto-execution means trades will be placed automatically based on AI recommendations. While convenient, this removes human oversight and could result in unexpected losses. Start with small position sizes and monitor closely.
                </div>
            </div>
        </div>
    </div>

    <script>
     
        const API_BASE = window.location.origin + '/api';
        
        function loadSettings() {
            const saved = localStorage.getItem('tradingSettings');
            const defaults = {
                autoExecute: false,
                confidenceThreshold: 75,
                humanApproval: true,
                positionSizingStrategy: 'equal',
                maxPositionSize: 5,
                takeProfitStrategy: 'full',
                autoStopLoss: true,
                coinUniverse: 'top25',
                discoveryStrategy: 'moderate',
                analysisFrequency: 4
            };
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        }
        
        function getSettings() {
            return loadSettings();
        }

        // ===================================================================
        // MIGRATED TO ui/discovery.js:
        // All discovery functions have been moved to modular files
        // ===================================================================

        // ============================================
        // MANUAL TRADING FUNCTIONS
        // ============================================
        
        let selectedTradeAction = 'BUY'; // Manual trading is always BUY (SELL done in holdings)

        function toggleAdvancedOptions() {
            const checkbox = document.getElementById('addStopLoss');
            const options = document.getElementById('advancedOptions');
            options.style.display = checkbox.checked ? 'block' : 'none';
        }

        function updateQuantityPlaceholder() {
            const type = document.getElementById('quantityType').value;
            const input = document.getElementById('manualTradeQuantity');
            const helper = document.getElementById('quantityHelper');
            
            if (type === 'units') {
                input.placeholder = 'Enter number of coins';
                helper.textContent = 'Example: 0.5 BTC';
            } else if (type === 'usd') {
                input.placeholder = 'Enter dollar amount';
                helper.textContent = 'Example: $1000';
            } else if (type === 'percent') {
                input.placeholder = 'Enter percentage';
                helper.textContent = 'Example: 5 (for 5% of portfolio)';
            }
        }

        async function previewTrade() {
            const symbol = document.getElementById('manualTradeSymbol').value.toUpperCase().trim();
            const quantity = parseFloat(document.getElementById('manualTradeQuantity').value);
            const quantityType = document.getElementById('quantityType').value;
            const addStopLoss = document.getElementById('addStopLoss').checked;
            const stopLossPrice = addStopLoss ? parseFloat(document.getElementById('stopLossPrice').value) : null;
            const takeProfitPrice = addStopLoss ? parseFloat(document.getElementById('takeProfitPrice').value) : null;
            
            const previewArea = document.getElementById('tradePreviewArea');
            
            if (!symbol || !quantity || quantity <= 0) {
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ö†Ô∏è Please enter a valid symbol and quantity
                    </div>
                `;
                return;
            }

            // Get current portfolio
            const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
            if (!portfolioResponse.ok) {
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ö†Ô∏è Unable to fetch portfolio data
                    </div>
                `;
                return;
            }

            const portfolio = await portfolioResponse.json();
            const totalValue = portfolio.totalValue || 10000; // Fallback

            // Get current price for the symbol
            try {
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) throw new Error('Price fetch failed');

                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Calculate actual quantity based on type
                let actualQuantity = quantity;
                let totalCost = 0;

                if (quantityType === 'usd') {
                    actualQuantity = quantity / currentPrice;
                    totalCost = quantity;
                } else if (quantityType === 'percent') {
                    totalCost = (quantity / 100) * totalValue;
                    actualQuantity = totalCost / currentPrice;
                } else {
                    // units
                    totalCost = quantity * currentPrice;
                }

                // Validate against portfolio
                if (totalCost > totalValue) {
                    previewArea.style.display = 'block';
                    previewArea.innerHTML = `
                        <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                            ‚ö†Ô∏è Insufficient funds! Trade cost: $${totalCost.toFixed(2)}, Portfolio value: $${totalValue.toFixed(2)}
                        </div>
                    `;
                    return;
                }

                // Calculate potential P&L with stop loss/take profit
                let stopLossInfo = '';
                let takeProfitInfo = '';

                if (addStopLoss && stopLossPrice) {
                    const stopLossAmount = (stopLossPrice - currentPrice) * actualQuantity;
                    const stopLossPercent = ((stopLossPrice - currentPrice) / currentPrice) * 100;
                    stopLossInfo = `
                        <div style="padding: 10px; background: #fee2e2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <strong>Stop Loss:</strong> $${stopLossPrice.toFixed(2)}<br>
                            <span style="font-size: 13px; color: #991b1b;">
                                Loss if triggered: $${Math.abs(stopLossAmount).toFixed(2)} (${stopLossPercent.toFixed(2)}%)
                            </span>
                        </div>
                    `;
                }

                if (addStopLoss && takeProfitPrice) {
                    const takeProfitAmount = (takeProfitPrice - currentPrice) * actualQuantity;
                    const takeProfitPercent = ((takeProfitPrice - currentPrice) / currentPrice) * 100;
                    takeProfitInfo = `
                        <div style="padding: 10px; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 4px;">
                            <strong>Take Profit:</strong> $${takeProfitPrice.toFixed(2)}<br>
                            <span style="font-size: 13px; color: #065f46;">
                                Gain if triggered: $${takeProfitAmount.toFixed(2)} (${takeProfitPercent.toFixed(2)}%)
                            </span>
                        </div>
                    `;
                }

                // Show preview
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0; color: #1e40af;">üìã Trade Preview</h4>
                        <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Symbol:</span>
                                <strong>${symbol}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Current Price:</span>
                                <strong>$${currentPrice.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Quantity:</span>
                                <strong>${actualQuantity.toFixed(6)} ${symbol}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #bfdbfe;">
                                <span>Total Cost:</span>
                                <strong style="color: #1e40af;">$${totalCost.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>% of Portfolio:</span>
                                <strong>${((totalCost / totalValue) * 100).toFixed(2)}%</strong>
                            </div>
                        </div>
                        ${stopLossInfo}
                        ${takeProfitInfo}
                        <button onclick="executeTrade()" class="button" style="width: 100%; margin-top: 15px;">
                            ‚úÖ Confirm Trade
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('Preview error:', error);
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ö†Ô∏è Unable to fetch price for ${symbol}. Please check the symbol and try again.
                    </div>
                `;
            }
        }

        async function executeTrade() {
            const symbol = document.getElementById('manualTradeSymbol').value.toUpperCase().trim();
            const quantity = parseFloat(document.getElementById('manualTradeQuantity').value);
            const quantityType = document.getElementById('quantityType').value;
            const addStopLoss = document.getElementById('addStopLoss').checked;
            const stopLossPrice = addStopLoss ? parseFloat(document.getElementById('stopLossPrice').value) : null;
            const takeProfitPrice = addStopLoss ? parseFloat(document.getElementById('takeProfitPrice').value) : null;

            try {
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) throw new Error('Price fetch failed');
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Get portfolio value for percent calculation
                const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                const portfolio = await portfolioResponse.json();
                const totalValue = portfolio.totalValue || 10000;

                let actualQuantity = quantity;
                if (quantityType === 'usd') {
                    actualQuantity = quantity / currentPrice;
                } else if (quantityType === 'percent') {
                    const costAmount = (quantity / 100) * totalValue;
                    actualQuantity = costAmount / currentPrice;
                }

                // Execute trade
                const response = await fetch(`${API_BASE}/trade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        quantity: actualQuantity,
                        side: 'BUY',
                        tradeType: 'manual',
                        stopLoss: stopLossPrice,
                        takeProfit: takeProfitPrice
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Trade failed');
                }

                await showSuccess(
                    'Trade Executed!',
                    `Successfully bought ${actualQuantity.toFixed(6)} ${symbol} at $${currentPrice.toFixed(2)}`
                );

                // Clear form and refresh
                document.getElementById('manualTradeSymbol').value = '';
                document.getElementById('manualTradeQuantity').value = '';
                document.getElementById('tradePreviewArea').style.display = 'none';
                loadPortfolio();
                loadTrades();

            } catch (error) {
                console.error('Trade error:', error);
                await showError('Trade Failed', error.message);
            }
        }

        // ============================================
        // END MANUAL TRADING FUNCTIONS
        // ============================================

        // ============================================
        // SELL POSITION FUNCTIONS
        // ============================================

        async function sellPosition(symbol, quantity) {
            // Confirm sale
            const confirmed = await showConfirm(
                'Sell Position',
                `Sell entire <strong>${symbol}</strong> position?<br><br>` +
                `<div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin: 12px 0;">` +
                `<strong>Quantity:</strong> ${quantity.toFixed(8)} ${symbol}` +
                `</div>` +
                `This will close your position and convert to cash.`,
                { confirmText: 'Sell Position', confirmColor: '#ef4444' }
            );
            if (!confirmed) return;

            try {
                // Get current price
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) throw new Error('Failed to get price');

                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Execute the sell
                const response = await fetch(`${API_BASE}/trade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        quantity,
                        side: 'SELL',
                        tradeType: 'manual'
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Sale failed');
                }

                await showSuccess(
                    'Position Sold!',
                    `Successfully sold ${quantity.toFixed(6)} ${symbol} at $${currentPrice.toFixed(2)}`
                );

                // Refresh displays
                loadPortfolio();
                loadTrades();

            } catch (error) {
                console.error('Sell error:', error);
                await showError('Sale Failed', error.message);
            }
        }

        // ============================================
        // END SELL POSITION FUNCTIONS
        // ============================================

        // Close modals when clicking outside
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal');
            const infoModal = document.getElementById('infoModal');
            
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
            if (event.target === infoModal) {
                closeInfoModal();
            }
        }

        // ============================================
        // CUSTOM MODAL SYSTEM
        // ============================================

        let modalResolveCallback = null;

        function showConfirm(title, message, options = {}) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmButton');
                const cancelBtn = document.getElementById('cancelButton');

                titleEl.textContent = title;
                messageEl.innerHTML = message;
                
                // Apply custom button text/colors if provided
                if (options.confirmText) confirmBtn.textContent = options.confirmText;
                else confirmBtn.textContent = 'Confirm';
                
                if (options.confirmColor) confirmBtn.style.background = options.confirmColor;
                else confirmBtn.style.background = '#667eea';

                modal.classList.add('active');
                modalResolveCallback = resolve;
            });
        }

        function handleConfirmClick(result) {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            if (modalResolveCallback) {
                modalResolveCallback(result);
                modalResolveCallback = null;
            }
        }

        function showSuccess(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('statusModal');
                const icon = document.getElementById('statusIcon');
                const titleEl = document.getElementById('statusTitle');
                const messageEl = document.getElementById('statusMessage');
                const okBtn = document.getElementById('statusOkButton');

                icon.textContent = '‚úÖ';
                icon.style.color = '#10b981';
                titleEl.textContent = title;
                titleEl.style.color = '#10b981';
                messageEl.innerHTML = message;

                modal.classList.add('active');

                okBtn.onclick = () => {
                    modal.classList.remove('active');
                    resolve();
                };
            });
        }

        function showError(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('statusModal');
                const icon = document.getElementById('statusIcon');
                const titleEl = document.getElementById('statusTitle');
                const messageEl = document.getElementById('statusMessage');
                const okBtn = document.getElementById('statusOkButton');

                icon.textContent = '‚ùå';
                icon.style.color = '#ef4444';
                titleEl.textContent = title;
                titleEl.style.color = '#ef4444';
                messageEl.innerHTML = message;

                modal.classList.add('active');

                okBtn.onclick = () => {
                    modal.classList.remove('active');
                    resolve();
                };
            });
        }

        // ============================================
        // END CUSTOM MODAL SYSTEM
        // ============================================

        // ============================================
        // POSITION DETAILS & PROTECTION MANAGEMENT
        // ============================================

        async function openPositionDetails(symbol) {
            try {
                // Fetch current portfolio and position data
                const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                const portfolio = await portfolioResponse.json();
                const position = portfolio.positions.find(p => p.symbol === symbol);

                if (!position) {
                    await showError('Position Not Found', `Could not find position for ${symbol}`);
                    return;
                }

                // Get current price
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Calculate percentages
                const priceChange = ((currentPrice - position.averagePrice) / position.averagePrice) * 100;
                const stopLossPercent = position.stopLoss ? (((currentPrice - position.stopLoss) / currentPrice) * 100).toFixed(1) : null;
                const takeProfitPercent = position.takeProfit ? (((position.takeProfit - currentPrice) / currentPrice) * 100).toFixed(1) : null;

                const message = `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Quantity</div>
                                <div style="font-weight: 600;">${position.quantity.toFixed(8)} ${symbol}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Current Value</div>
                                <div style="font-weight: 600;">$${(position.quantity * currentPrice).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Avg Buy Price</div>
                                <div style="font-weight: 600;">$${formatPrice(position.averagePrice)}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Current Price</div>
                                <div style="font-weight: 600;">$${formatPrice(currentPrice)}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Total P&L</div>
                                <div style="font-weight: 600; color: ${position.unrealizedPnL >= 0 ? '#10b981' : '#ef4444'};">
                                    ${position.unrealizedPnL >= 0 ? '+' : ''}$${position.unrealizedPnL.toFixed(2)} (${priceChange.toFixed(2)}%)
                                </div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Portfolio %</div>
                                <div style="font-weight: 600;">${((position.quantity * currentPrice) / portfolio.totalValue * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>

                    ${position.stopLoss || position.takeProfit ? `
                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #10b981;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #065f46;">üõ°Ô∏è Active Protections</div>
                        <div style="display: grid; gap: 10px;">
                            ${position.stopLoss ? `
                                <div style="padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="color: #92400e; font-weight: 600; margin-bottom: 4px;">üõë Stop Loss</div>
                                    <div style="font-size: 14px; color: #6b7280;">
                                        Price: <strong>$${formatPrice(position.stopLoss)}</strong> (-${stopLossPercent}%)
                                    </div>
                                </div>
                            ` : ''}
                            ${position.takeProfit ? `
                                <div style="padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="color: #065f46; font-weight: 600; margin-bottom: 4px;">üéØ Take Profit</div>
                                    <div style="font-size: 14px; color: #6b7280;">
                                        Price: <strong>$${formatPrice(position.takeProfit)}</strong> (+${takeProfitPercent}%)
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="sellPosition('${symbol}', ${position.quantity})" class="button" style="flex: 1; background: #ef4444;">
                            üí∞ Sell Position
                        </button>
                        <button onclick="openProtectionManager('${symbol}')" class="button" style="flex: 1; background: #667eea;">
                            üõ°Ô∏è Manage Protections
                        </button>
                    </div>
                `;

                await showConfirm(`Position: ${symbol}`, message, { 
                    confirmText: 'Close', 
                    confirmColor: '#6b7280' 
                });

            } catch (error) {
                console.error('Failed to load position details:', error);
                await showError('Error', 'Failed to load position details');
            }
        }

        async function openProtectionManager(symbol) {
            try {
                const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                const portfolio = await portfolioResponse.json();
                const position = portfolio.positions.find(p => p.symbol === symbol);

                if (!position) {
                    await showError('Position Not Found', `Could not find position for ${symbol}`);
                    return;
                }

                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                const message = `
                    <div style="margin-bottom: 20px;">
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                            <div style="color: #6b7280; font-size: 13px;">Current Price</div>
                            <div style="font-size: 20px; font-weight: 600;">$${formatPrice(currentPrice)}</div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üõë Stop Loss Price</label>
                            <input type="number" id="stopLossInput" value="${position.stopLoss || ''}" 
                                placeholder="Enter stop loss price" 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                Auto-sell if price drops to this level
                            </div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üéØ Take Profit Price</label>
                            <input type="number" id="takeProfitInput" value="${position.takeProfit || ''}" 
                                placeholder="Enter take profit price" 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                Auto-sell if price rises to this level
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveProtection('${symbol}', 'stopLoss')" class="button" style="flex: 1; background: #ef4444;">
                            Save Stop Loss
                        </button>
                        <button onclick="saveProtection('${symbol}', 'takeProfit')" class="button" style="flex: 1; background: #10b981;">
                            Save Take Profit
                        </button>
                    </div>
                `;

                await showConfirm(`Manage Protections: ${symbol}`, message, {
                    confirmText: 'Done',
                    confirmColor: '#6b7280'
                });

            } catch (error) {
                console.error('Failed to open protection manager:', error);
                await showError('Error', 'Failed to open protection manager');
            }
        }

        async function saveProtection(symbol, type) {
            try {
                const input = document.getElementById(type === 'stopLoss' ? 'stopLossInput' : 'takeProfitInput');
                const price = parseFloat(input.value);

                const payload = {};
                if (price && price > 0) {
                    payload[type] = price;
                } else {
                    payload[type] = null; // Remove protection
                }

                const response = await fetch(`${API_BASE}/portfolio/${symbol}/protection`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to update protection');
                }

                await showSuccess(
                    'Protection Updated',
                    `${type === 'stopLoss' ? 'Stop loss' : 'Take profit'} ${price ? 'set to $' + price.toFixed(2) : 'removed'} for ${symbol}`
                );

                // Refresh portfolio to show updated data
                loadPortfolio();

            } catch (error) {
                console.error('Failed to save protection:', error);
                await showError('Update Failed', error.message);
            }
        }

        // ============================================
        // END POSITION DETAILS & PROTECTION MANAGEMENT
        // ============================================
    </script>

    <!-- Custom Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirm Action</h2>
            </div>
            <div class="modal-body">
                <div id="confirmMessage" style="line-height: 1.6;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="handleConfirmClick(false)" id="cancelButton" class="button" style="background: #6b7280;">Cancel</button>
                <button onclick="handleConfirmClick(true)" id="confirmButton" class="button">Confirm</button>
            </div>
        </div>
    </div>

        <!-- Custom Modal -->
        <div id="customModal" class="modal-overlay">
            <div class="modal-content">
                <div id="modalHeader" class="modal-header">
                    <h3>Notification</h3>
                </div>
                <div id="modalBody" class="modal-body">
                    Modal content goes here
                </div>
                <div id="modalFooter" class="modal-footer">
                    <button class="button">OK</button>
                </div>
            </div>
        </div>

    <!-- Status Modal (for success/error messages) -->
    <div id="statusModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div id="statusIcon" style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                <h3 id="statusTitle" style="margin-bottom: 10px;">Success!</h3>
                <div id="statusMessage" style="color: #6b7280; line-height: 1.6;"></div>
                <button id="statusOkButton" class="button" style="margin-top: 20px; width: 100%;">OK</button>
            </div>
        </div>
    </div>

    <!-- Load Modular JavaScript -->
    <script type="module" src="/js/main.js"></script>
</body>
</html>