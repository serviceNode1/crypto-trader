<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #2e0197 0%, #460066);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            
        }

        .card {
            margin: 10px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-size: 20px;
            font-weight: bold;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .neutral {
            color: #6b7280;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .button:hover {
            background: #5568d3;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        .chart-container canvas {
            max-height: 250px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-up {
            background: #10b981;
        }

        .status-down {
            background: #ef4444;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-buy {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-sell {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-hold {
            background: #e5e7eb;
            color: #374151;
        }

        .refresh-btn {
            float: right;
            font-size: 12px;
            padding: 6px 12px;
        }

        /* Info Button */
        .info-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .info-button:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #e5e7eb;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .info-section {
            margin-bottom: 30px;
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .info-table th,
        .info-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }

        .info-table tr:hover {
            background: #f9fafb;
        }

        .tip-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .tip-box strong {
            color: #1e40af;
        }

        /* Settings Styles */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-info h4 {
            margin: 0 0 5px 0;
            color: #374151;
            font-size: 16px;
        }

        .setting-info p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }

        .setting-control {
            margin-left: 20px;
            display: flex;
            align-items: center;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 30px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Range Slider */
        .range-slider {
            width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .range-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .range-slider input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .range-value {
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        /* Select Dropdown */
        .setting-select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
            transition: border-color 0.3s;
        }

        .setting-select:hover {
            border-color: #667eea;
        }

        .setting-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .tip-box strong {
            color: #3b82f6;
        }

        .warning-box {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .warning-box strong {
            color: #ef4444;
        }

        .success-box {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .success-box strong {
            color: #10b981;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Crypto Selector Styles */
        .crypto-selector {
            padding: 10px 0;
        }

        .search-container {
            display: flex;
            align-items: center;
        }

        #cryptoSearch:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .popular-coins {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .coin-button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .coin-button:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea10, #764ba210);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .coin-button:active {
            transform: translateY(0);
        }

        .coin-icon {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .coin-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .coin-symbol {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
        }

        .analysis-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 8px;
            color: #3b82f6;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

            .analysis-stat {
                display: flex;
                justify-content: space-between;
                padding: 12px;
                background: white;
                border-radius: 6px;
                margin: 8px 0;
            }

            .analysis-stat-label {
                color: #6b7280;
                font-weight: 500;
            }

            .analysis-stat-value {
                color: #1f2937;
                font-weight: 600;
            }

        /* Modal System */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-body {
            padding: 24px;
            color: #4b5563;
            line-height: 1.6;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-warning-list {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .modal-warning-list li {
            margin: 12px 0 12px 24px;
            color: #92400e;
        }

        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Crypto Trading Dashboard</h1>
                    <p class="subtitle">AI-Powered Paper Trading System | Starting Capital: $10,000</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="info-button" onclick="openSettingsModal()" title="Trading Settings">
                        ‚öôÔ∏è
                    </button>
                    <button class="info-button" onclick="openInfoModal()" title="Trading Guide & Information">
                        üí°
                    </button>
                </div>
            </div>
        </header>

        <div class="warning">
            ‚ö†Ô∏è <strong>PAPER TRADING MODE</strong> - This system uses virtual money only. No real trades are executed.
        </div>

        <!-- Crypto Selector -->
        <div class="card" style="margin-bottom: 30px;">
            <h2>üîç Select Cryptocurrency to Analyze</h2>
            <div class="crypto-selector">
                <div class="search-container">
                    <input 
                        type="text" 
                        id="cryptoSearch" 
                        placeholder="Enter symbol (e.g., BTC, ETH, SOL, ADA)..." 
                        style="flex: 1; padding: 12px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; transition: border 0.3s;"
                        onkeypress="if(event.key === 'Enter') analyzeCrypto()"
                    />
                    <button class="button" onclick="analyzeCrypto()" style="margin-left: 10px; padding: 12px 24px;">
                        üîç Analyze
                    </button>
                </div>

                <!-- AI Model Selector -->
                <div style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px; font-size: 14px;">
                        ü§ñ AI Analysis Model:
                    </label>
                    <select id="aiModelSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">
                        <option value="local">üíª Local Analysis (Free - No AI)</option>
                        <option value="openai">ü§ñ OpenAI GPT-4o-mini (Cheapest AI - $0.0007)</option>
                        <option value="anthropic" selected>üß† Anthropic Claude Haiku (Fast - $0.0014)</option>
                        <option value="both">üî¨ Both Models - Consensus ($0.0021)</option>
                    </select>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">
                        <strong>Estimated Cost per Analysis:</strong> Local = $0 | OpenAI = $0.0007 | Anthropic = $0.0014 | Both = $0.0021
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <p style="color: #6b7280; margin-bottom: 10px; font-size: 14px;">Or choose from popular cryptocurrencies:</p>
                    <div class="popular-coins">
                        <button class="coin-button" onclick="selectCrypto('BTC')">
                            <span class="coin-icon">‚Çø</span>
                            <div>
                                <div class="coin-name">Bitcoin</div>
                                <div class="coin-symbol">BTC</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('ETH')">
                            <span class="coin-icon">Œû</span>
                            <div>
                                <div class="coin-name">Ethereum</div>
                                <div class="coin-symbol">ETH</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('SOL')">
                            <span class="coin-icon">‚óé</span>
                            <div>
                                <div class="coin-name">Solana</div>
                                <div class="coin-symbol">SOL</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('ADA')">
                            <span class="coin-icon">‚Ç≥</span>
                            <div>
                                <div class="coin-name">Cardano</div>
                                <div class="coin-symbol">ADA</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('AVAX')">
                            <span class="coin-icon">‚ñ≤</span>
                            <div>
                                <div class="coin-name">Avalanche</div>
                                <div class="coin-symbol">AVAX</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('DOT')">
                            <span class="coin-icon">‚óè</span>
                            <div>
                                <div class="coin-name">Polkadot</div>
                                <div class="coin-symbol">DOT</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('MATIC')">
                            <span class="coin-icon">‚¨°</span>
                            <div>
                                <div class="coin-name">Polygon</div>
                                <div class="coin-symbol">MATIC</div>
                            </div>
                        </button>
                        <button class="coin-button" onclick="selectCrypto('LINK')">
                            <span class="coin-icon">‚¨¢</span>
                            <div>
                                <div class="coin-name">Chainlink</div>
                                <div class="coin-symbol">LINK</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Result Display -->
            <div id="analysisResult" style="display: none; margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="analysisTitle" style="margin: 0; color: #667eea;">Analysis Results</h3>
                    <button onclick="closeAnalysis()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6b7280;">√ó</button>
                </div>
                <div id="analysisContent" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="card">
            <h2>ü§ñ AI Recommendations</h2>
            <div id="recommendations-list" class="loading">Loading...</div>
        </div>

        <!-- Discovery Dashboard -->
        <div class="card" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üîç Discovered Opportunities</h2>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <select id="discoveryUniverseSelect" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" onchange="saveDiscoverySettings()">
                        <option value="top10">Top 10</option>
                        <option value="top25">Top 25</option>
                        <option value="top50">Top 50</option>
                        <option value="top100">Top 100</option>
                    </select>
                    <select id="discoveryStrategySelect" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" onchange="saveDiscoverySettings()">
                        <option value="conservative">üõ°Ô∏è Conservative</option>
                        <option value="moderate">‚öñÔ∏è Moderate</option>
                        <option value="aggressive">üöÄ Aggressive</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #6b7280; cursor: pointer;">
                        <input type="checkbox" id="forceRefreshCheckbox" style="cursor: pointer;">
                        <span>Force Refresh</span>
                    </label>
                    <button class="button" onclick="runDiscovery()" id="discoveryBtn">
                        üöÄ Run Discovery
                    </button>
                </div>
            </div>
            
            <!-- Last Discovery Info -->
            <div id="discovery-info" style="display: none; margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px; font-size: 13px; color: #6b7280;">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <span>üìÖ <strong>Last Run:</strong> <span id="discovery-timestamp">Never</span></span>
                    <span>‚è±Ô∏è <strong>Execution Time:</strong> <span id="discovery-execution-time">-</span></span>
                    <span>üíæ <strong>Cache Used:</strong> <span id="discovery-cache-status">-</span></span>
                </div>
            </div>
            
            <div id="discovery-status" style="display: none; margin-bottom: 15px; padding: 12px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                <div class="spinner" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 10px;"></div>
                <span id="discovery-message">Scanning markets...</span>
            </div>

            <!-- Analysis Log (Thinking Process) -->
            <div id="analysis-log-container" style="display: none; margin-bottom: 15px; border: 1px solid #e5e7eb; border-radius: 6px; background: #fafafa;">
                <div onclick="toggleAnalysisLog()" style="padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; border-radius: 6px 6px 0 0;">
                    <div>
                        <strong style="color: #374151;">üî¨ Analysis Log</strong>
                        <span id="log-summary" style="margin-left: 10px; color: #6b7280; font-size: 14px;"></span>
                    </div>
                    <span id="log-toggle" style="color: #6b7280; font-size: 20px;">‚ñº</span>
                </div>
                <div id="analysis-log-content" style="max-height: 400px; overflow-y: auto; display: none;">
                    <!-- Log entries will be added here -->
                </div>
            </div>
            
            <div id="discoveries-list">
                <p style="color: #6b7280; text-align: center; padding: 20px;">
                    Click "Run Discovery" to find trading opportunities based on your coin universe setting.
                </p>
            </div>
        </div>

        <!-- Manual Trading Widget -->
        <div class="card" style="margin-bottom: 30px;">
            <h2>üí∞ Buy Cryptocurrency</h2>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">
                Purchase any cryptocurrency manually. Use "Current Holdings" below to sell existing positions.
            </p>
            
            <div style="display: grid; gap: 12px;">
                <!-- Symbol and Amount in one row -->
                <div style="display: grid; grid-template-columns: 140px 1fr auto; gap: 10px; align-items: end;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; color: #374151; font-size: 13px;">Symbol</label>
                        <input 
                            type="text" 
                            id="manualTradeSymbol" 
                            placeholder="e.g., ZEC"
                            style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                            onkeyup="this.value = this.value.toUpperCase()"
                        >
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; color: #374151; font-size: 13px;">Amount</label>
                        <input 
                            type="number" 
                            id="manualTradeQuantity" 
                            placeholder="Enter amount"
                            step="0.00000001"
                            min="0"
                            style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                        >
                    </div>
                    <select 
                        id="quantityType" 
                        onchange="updateQuantityPlaceholder()"
                        style="padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 130px;">
                        <option value="usd">USD Amount</option>
                        <option value="units">Units</option>
                        <option value="percent">% of Portfolio</option>
                    </select>
                </div>
                <div id="quantityHelper" style="font-size: 12px; color: #6b7280; margin-top: -8px;"></div>

                <!-- Optional: Stop Loss & Take Profit -->
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="addStopLoss" onchange="toggleAdvancedOptions()" style="cursor: pointer;">
                        <span style="font-weight: 600; color: #374151;">Add Stop-Loss & Take-Profit</span>
                    </label>
                    <div id="advancedOptions" style="display: none; margin-top: 10px; padding: 15px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 14px; font-weight: 500; color: #374151; display: block; margin-bottom: 5px;">
                                üõë Stop-Loss Price ($)
                            </label>
                            <input 
                                type="number" 
                                id="stopLossPrice" 
                                step="0.01" 
                                min="0"
                                placeholder="Auto-sell if price drops to..."
                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="font-size: 14px; font-weight: 500; color: #374151; display: block; margin-bottom: 5px;">
                                üéØ Take-Profit Price ($)
                            </label>
                            <input 
                                type="number" 
                                id="takeProfitPrice" 
                                step="0.01" 
                                min="0"
                                placeholder="Auto-sell if price reaches..."
                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <!-- Preview Button -->
                <div>
                    <button 
                        class="button" 
                        onclick="previewTrade()"
                        style="width: 100%; background: #667eea;">
                        üëÅÔ∏è Preview Trade
                    </button>
                </div>

                <!-- Trade Preview & Execute Area -->
                <div id="tradePreviewArea" style="display: none;"></div>
            </div>
        </div>

        <!-- Portfolio Overview -->
        <div class="grid">
            <div class="card">
                <h2>Portfolio Overview <button class="button refresh-btn" onclick="loadPortfolio()">‚Üª Refresh</button></h2>
                <div id="portfolio-metrics" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Performance Metrics</h2>
                <div id="performance-metrics" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Risk Exposure</h2>
                <div id="risk-metrics" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Current Holdings (Full Width) -->
        <div class="card">
            <h2>üíº Current Holdings</h2>
            <div id="holdings-list" class="loading">Loading...</div>
        </div>

        <!-- Portfolio Value Chart -->
        <div class="card">
            <h2>üìà Portfolio Value Over Time</h2>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Trade History -->
        <div class="card">
            <h2>Recent Trades <button class="button refresh-btn" onclick="loadTrades()">‚Üª Refresh</button></h2>
            <div id="trades-list" class="loading">Loading...</div>
        </div>

        <!-- Market Context -->
        <div class="card">
            <h2>Market Context</h2>
            <div id="market-context" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';

        // Load portfolio data
        async function loadPortfolio() {
            try {
                const response = await fetch(`${API_BASE}/portfolio`);
                const data = await response.json();

                const metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Value</span>
                        <span class="metric-value">$${data.totalValue.toFixed(2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cash Balance</span>
                        <span class="metric-value">$${data.cash.toFixed(2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Return</span>
                        <span class="metric-value ${data.totalReturn >= 0 ? 'positive' : 'negative'}">
                            ${data.totalReturn >= 0 ? '+' : ''}$${data.totalReturn.toFixed(2)}
                            (${data.totalReturnPercent.toFixed(2)}%)
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Open Positions</span>
                        <span class="metric-value">${data.positions.length}</span>
                    </div>
                `;

                document.getElementById('portfolio-metrics').innerHTML = metricsHTML;

                // Display holdings
                if (data.positions.length > 0) {
                    const holdingsHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>Current Value</th>
                                    <th>P&L</th>
                                    <th>Stop Loss</th>
                                    <th>Take Profit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.positions.map(pos => {
                                    const currentPrice = pos.currentValue / pos.quantity;
                                    const priceChange = ((currentPrice - pos.averagePrice) / pos.averagePrice) * 100;
                                    return `
                                    <tr>
                                        <td><strong>${pos.symbol}</strong></td>
                                        <td>${pos.quantity.toFixed(4)}</td>
                                        <td>$${pos.averagePrice.toFixed(2)}</td>
                                        <td style="font-weight: 600; color: ${priceChange >= 0 ? '#10b981' : '#ef4444'};">
                                            $${currentPrice.toFixed(2)}
                                            <span style="font-size: 11px;">(${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(1)}%)</span>
                                        </td>
                                        <td>$${pos.currentValue.toFixed(2)}</td>
                                        <td class="${pos.unrealizedPnL >= 0 ? 'positive' : 'negative'}">
                                            ${pos.unrealizedPnL >= 0 ? '+' : ''}$${pos.unrealizedPnL.toFixed(2)}
                                            (${pos.unrealizedPnLPercent.toFixed(2)}%)
                                        </td>
                                        <td style="font-size: 13px; color: ${pos.stopLoss ? '#f59e0b' : '#9ca3af'};">
                                            ${pos.stopLoss ? '$' + pos.stopLoss.toFixed(2) : '‚Äî'}
                                        </td>
                                        <td style="font-size: 13px; color: ${pos.takeProfit ? '#10b981' : '#9ca3af'};">
                                            ${pos.takeProfit ? '$' + pos.takeProfit.toFixed(2) : '‚Äî'}
                                        </td>
                                        <td>
                                            <button 
                                                class="button" 
                                                onclick="openPositionDetails('${pos.symbol}')"
                                                style="background: #667eea; padding: 6px 12px; font-size: 12px; white-space: nowrap; margin-right: 5px; min-width: 85px;">
                                                üìã Details
                                            </button>
                                            <button 
                                                class="button" 
                                                onclick="sellPosition('${pos.symbol}', ${pos.quantity})"
                                                style="background: #ef4444; padding: 6px 12px; font-size: 12px; white-space: nowrap; min-width: 85px;">
                                                üìâ Sell
                                            </button>
                                        </td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('holdings-list').innerHTML = holdingsHTML;
                } else {
                    document.getElementById('holdings-list').innerHTML = '<p>No open positions</p>';
                }
            } catch (error) {
                console.error('Failed to load portfolio:', error);
                document.getElementById('portfolio-metrics').innerHTML = '<p class="negative">Failed to load data</p>';
            }
        }

        // Load performance metrics
        async function loadPerformance() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/performance`);
                const data = await response.json();

                const metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Sharpe Ratio</span>
                        <span class="metric-value">${data.sharpeRatio.toFixed(2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max Drawdown</span>
                        <span class="metric-value negative">${(data.maxDrawdown * 100).toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Win Rate</span>
                        <span class="metric-value">${(data.winRate * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric" title="Number of completed sell transactions (buy-sell cycles)">
                        <span class="metric-label">Closed Positions</span>
                        <span class="metric-value">${data.totalTrades}</span>
                    </div>
                `;

                document.getElementById('performance-metrics').innerHTML = metricsHTML;
            } catch (error) {
                console.error('Failed to load performance:', error);
            }
        }

        // Load risk metrics
        async function loadRisk() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/risk`);
                const data = await response.json();

                const metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Portfolio Risk</span>
                        <span class="metric-value">${data.portfolioRisk.toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Daily Loss</span>
                        <span class="metric-value">${data.dailyLoss.toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Capital Utilization</span>
                        <span class="metric-value">${data.utilizationPercent.toFixed(1)}%</span>
                    </div>
                `;

                document.getElementById('risk-metrics').innerHTML = metricsHTML;
            } catch (error) {
                console.error('Failed to load risk:', error);
            }
        }

        // Portfolio Chart
        let portfolioChart = null;

        async function loadPortfolioChart() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/history`);
                const data = await response.json();

                const ctx = document.getElementById('portfolioChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (portfolioChart) {
                    portfolioChart.destroy();
                }

                // Prepare data
                const labels = data.map(d => new Date(d.timestamp).toLocaleDateString());
                const values = data.map(d => d.totalValue);

                // Create chart
                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return 'Value: $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load portfolio chart:', error);
                const canvas = document.getElementById('portfolioChart');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No historical data available yet. Start trading to see your portfolio value over time!</p>';
                }
            }
        }

        // Trade pagination
        let currentTradePage = 1;
        const tradesPerPage = 10;

        // Load trades with pagination
        async function loadTrades(page = 1) {
            try {
                currentTradePage = page;
                const offset = (page - 1) * tradesPerPage;
                
                // Single API call now returns both trades and count
                const response = await fetch(`${API_BASE}/trades?limit=${tradesPerPage}&offset=${offset}`);
                const result = await response.json();
                
                const data = result.trades || result; // Support both old and new format
                const totalTrades = result.total || data.length;
                const totalPages = Math.ceil(totalTrades / tradesPerPage);

                if (data.length > 0) {
                    const tradesHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(trade => {
                                    const tradeType = trade.tradeType || trade.trade_type || 'manual';
                                    const typeLabel = {
                                        'manual': 'üë§ Manual',
                                        'automatic': 'ü§ñ AI',
                                        'stop_loss': 'üõ°Ô∏è Stop Loss',
                                        'take_profit': 'üéØ Take Profit'
                                    }[tradeType] || 'üë§ Manual';
                                    const typeColor = {
                                        'manual': '#667eea',
                                        'automatic': '#10b981',
                                        'stop_loss': '#f59e0b',
                                        'take_profit': '#10b981'
                                    }[tradeType] || '#667eea';
                                    
                                    return `
                                    <tr>
                                        <td>${new Date(trade.executedAt || trade.executed_at).toLocaleString()}</td>
                                        <td><strong>${trade.symbol}</strong></td>
                                        <td><span class="badge badge-${trade.side.toLowerCase()}">${trade.side}</span></td>
                                        <td><span style="font-size: 12px; color: ${typeColor}; font-weight: 500;">${typeLabel}</span></td>
                                        <td>${parseFloat(trade.quantity).toFixed(4)}</td>
                                        <td>$${parseFloat(trade.price).toFixed(2)}</td>
                                        <td>$${parseFloat(trade.totalCost || trade.total_cost).toFixed(2)}</td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                        ${totalPages > 1 ? `
                            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <button 
                                    class="button" 
                                    onclick="loadTrades(${page - 1})" 
                                    ${page === 1 ? 'disabled' : ''}
                                    style="padding: 6px 12px; font-size: 13px; ${page === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    ‚Üê Previous
                                </button>
                                <span style="color: #6b7280; font-size: 13px;">
                                    Page ${page} of ${totalPages} (${totalTrades} total trades)
                                </span>
                                <button 
                                    class="button" 
                                    onclick="loadTrades(${page + 1})" 
                                    ${page === totalPages ? 'disabled' : ''}
                                    style="padding: 6px 12px; font-size: 13px; ${page === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    Next ‚Üí
                                </button>
                            </div>
                        ` : ''}
                    `;
                    document.getElementById('trades-list').innerHTML = tradesHTML;
                } else {
                    document.getElementById('trades-list').innerHTML = '<p>No trades yet</p>';
                }
            } catch (error) {
                console.error('Failed to load trades:', error);
            }
        }

        // Load recommendations
        async function loadRecommendations() {
            try {
                const response = await fetch(`${API_BASE}/recommendations?limit=5`);
                const data = await response.json();

                if (data.length > 0) {
                    const recsHTML = data.map(rec => `
                        <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="font-size: 16px;">${rec.symbol}</strong>
                                <span class="badge badge-${rec.action.toLowerCase()}">${rec.action}</span>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                Confidence: <strong>${rec.confidence}%</strong> | 
                                Risk: <strong>${rec.riskLevel}</strong>
                            </div>
                            ${rec.entryPrice ? `<div style="color: #666; font-size: 14px;">Entry: $${rec.entryPrice.toFixed(2)}</div>` : ''}
                            ${rec.stopLoss ? `<div style="color: #666; font-size: 14px;">Stop Loss: $${rec.stopLoss.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                    document.getElementById('recommendations-list').innerHTML = recsHTML;
                } else {
                    document.getElementById('recommendations-list').innerHTML = '<p>No active recommendations</p>';
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
            }
        }

        // Load market context
        async function loadMarketContext() {
            try {
                const response = await fetch(`${API_BASE}/market-context`);
                const data = await response.json();

                const contextHTML = `
                    <div class="metric">
                        <span class="metric-label">BTC Dominance</span>
                        <span class="metric-value">${data.context.btcDominance.toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Market Regime</span>
                        <span class="metric-value">${data.context.marketRegime.toUpperCase()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Risk Sentiment</span>
                        <span class="metric-value">${data.context.riskSentiment.toUpperCase()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">VIX</span>
                        <span class="metric-value">${data.context.traditionalMarkets.vix.toFixed(2)}</span>
                    </div>
                `;

                document.getElementById('market-context').innerHTML = contextHTML;
            } catch (error) {
                console.error('Failed to load market context:', error);
            }
        }

        // Load all data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
            loadTrades();
            loadRecommendations();
            loadMarketContext();
            loadPerformance();  
            loadRisk();          
            loadPortfolioChart(); 
            applySettings();

            // Refresh every 30 seconds (captures position monitor auto-trades)
            setInterval(() => {
                loadPortfolio();
                loadTrades();
                loadPerformance();
                loadRisk();
                loadPortfolioChart();
            }, 30000);
        });

        // Modal control functions
        function openInfoModal() {
            document.getElementById('infoModal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }

        // Crypto Selector Functions
        function selectCrypto(symbol) {
            document.getElementById('cryptoSearch').value = symbol.toUpperCase();
            analyzeCrypto();
        }

        async function analyzeCrypto() {
            const symbol = document.getElementById('cryptoSearch').value.trim().toUpperCase();
            const aiModel = document.getElementById('aiModelSelect').value;
            
            if (!symbol) {
                alert('Please enter a cryptocurrency symbol');
                return;
            }

            const resultDiv = document.getElementById('analysisResult');
            const contentDiv = document.getElementById('analysisContent');
            const titleDiv = document.getElementById('analysisTitle');
            
            // Get model display name
            const modelNames = {
                'local': 'Local Analysis',
                'anthropic': 'Anthropic Claude',
                'openai': 'OpenAI GPT-4',
                'both': 'AI Consensus'
            };
            const modelName = modelNames[aiModel] || aiModel;
            
            // Show loading state
            resultDiv.style.display = 'block';
            titleDiv.textContent = `Analyzing ${symbol} with ${modelName}...`;
            contentDiv.innerHTML = `
                <div class="analysis-loading">
                    <div class="spinner"></div>
                    <div>
                        <strong>Fetching comprehensive analysis...</strong><br>
                        <span style="font-size: 14px;">Using ${modelName} ‚Ä¢ This may take ${aiModel === 'both' ? '30-60' : '10-30'} seconds</span>
                    </div>
                </div>
            `;
            
            // Scroll to results
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            try {
                // Call the analysis endpoint with model parameter
                const response = await fetch(`${API_BASE}/analyze/${symbol}?model=${aiModel}`);
                
                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Display results
                titleDiv.textContent = `‚úÖ Analysis Complete: ${symbol}`;
                contentDiv.innerHTML = formatAnalysisResults(data);
                
            } catch (error) {
                console.error('Analysis error:', error);
                titleDiv.textContent = `‚ùå Analysis Failed`;
                contentDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <strong>Unable to analyze ${symbol}</strong><br>
                        <span style="font-size: 14px;">${error.message}</span><br><br>
                        <p style="font-size: 14px; color: #6b7280;">
                            Make sure the symbol is correct and try again. Popular symbols: BTC, ETH, SOL, ADA, AVAX, DOT, MATIC, LINK
                        </p>
                    </div>
                `;
            }
        }

        function createCandlestickChart(candlesticks, currentPrice) {
            if (!candlesticks || candlesticks.length === 0) return '<p>No chart data available</p>';
            
            // Find min and max prices for scaling
            const prices = candlesticks.flatMap(c => [c.high, c.low]);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.1; // 10% padding
            
            // Calculate dimensions
            const chartWidth = 100; // percentage
            const chartHeight = 220; // pixels
            const candleWidth = chartWidth / candlesticks.length * 0.7; // 70% of available space
            const candleGap = chartWidth / candlesticks.length * 0.3; // 30% gap
            
            // Generate candlesticks
            const candles = candlesticks.map((candle, index) => {
                const isGreen = candle.close >= candle.open;
                const color = isGreen ? '#10b981' : '#ef4444';
                
                // Calculate positions (inverted Y axis for SVG)
                const high = ((maxPrice + padding - candle.high) / (priceRange + 2 * padding)) * 100;
                const low = ((maxPrice + padding - candle.low) / (priceRange + 2 * padding)) * 100;
                const open = ((maxPrice + padding - candle.open) / (priceRange + 2 * padding)) * 100;
                const close = ((maxPrice + padding - candle.close) / (priceRange + 2 * padding)) * 100;
                
                const bodyTop = Math.min(open, close);
                const bodyBottom = Math.max(open, close);
                const bodyHeight = Math.abs(close - open);
                
                const x = (index / candlesticks.length) * 100 + candleGap / 2;
                
                return `
                    <g>
                        <!-- Wick -->
                        <line x1="${x + candleWidth/2}%" y1="${high}%" 
                              x2="${x + candleWidth/2}%" y2="${low}%" 
                              stroke="${color}" stroke-width="1"/>
                        <!-- Body -->
                        <rect x="${x}%" y="${bodyTop}%" 
                              width="${candleWidth}%" height="${bodyHeight || 0.5}%" 
                              fill="${color}" stroke="${color}"/>
                    </g>
                `;
            }).join('');
            
            // Current price line
            const currentPriceY = ((maxPrice + padding - currentPrice) / (priceRange + 2 * padding)) * 100;
            
            return `
                <svg width="100%" height="${chartHeight}px" style="display: block;">
                    ${candles}
                    <!-- Current Price Line -->
                    <line x1="0%" y1="${currentPriceY}%" x2="100%" y2="${currentPriceY}%" 
                          stroke="#667eea" stroke-width="2" stroke-dasharray="5,5" opacity="0.7"/>
                    <text x="2" y="${currentPriceY - 2}%" fill="#667eea" font-size="10" font-weight="bold">
                        Current: $${currentPrice.toLocaleString()}
                    </text>
                    
                    <!-- Price labels -->
                    <text x="2" y="8" fill="#6b7280" font-size="10">
                        $${maxPrice.toLocaleString()}
                    </text>
                    <text x="2" y="${chartHeight - 2}" fill="#6b7280" font-size="10">
                        $${minPrice.toLocaleString()}
                    </text>
                </svg>
            `;
        }

        function formatAnalysisResults(data) {
            const recommendation = data.recommendation || {};
            const technical = data.technical || {};
            const sentiment = data.sentiment || {};
            
            return `
                <div style="display: grid; gap: 20px;">
                    <!-- Quick Summary -->
                    <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid ${
                        recommendation.action === 'BUY' ? '#10b981' : 
                        recommendation.action === 'SELL' ? '#ef4444' : '#6b7280'
                    };">
                        <h4 style="margin: 0 0 10px 0; color: #1f2937;">AI Recommendation</h4>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <span style="padding: 8px 16px; background: ${
                                recommendation.action === 'BUY' ? '#10b981' : 
                                recommendation.action === 'SELL' ? '#ef4444' : '#6b7280'
                            }; color: white; border-radius: 6px; font-weight: 600; font-size: 18px;">
                                ${recommendation.action || 'HOLD'}
                            </span>
                            <span style="font-size: 16px; color: #6b7280;">
                                Confidence: <strong style="color: #1f2937;">${recommendation.confidence || 0}%</strong>
                            </span>
                        </div>
                        <p style="color: #6b7280; margin: 0; line-height: 1.6;">
                            ${recommendation.reasoning?.conclusion || 'Analysis in progress...'}
                        </p>
                    </div>

                    <!-- Price Chart -->
                    ${data.candlesticks && data.candlesticks.length > 0 ? `
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìà Price Chart (Last 30 Periods)</h4>
                        <div style="position: relative; height: 250px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                            ${createCandlestickChart(data.candlesticks, data.currentPrice)}
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #6b7280; text-align: center;">
                            Each bar represents ${data.candlesticks.length > 0 ? '~4 hours' : 'N/A'} ‚Ä¢ 
                            Source: ${data.symbol} OHLC data
                        </p>
                    </div>
                    ` : ''}

                    <!-- Price & Technical -->
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìä Technical Analysis</h4>
                        <div style="display: grid; gap: 10px;">
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Current Price</span>
                                <span class="analysis-stat-value">$${data.currentPrice?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Trend</span>
                                <span class="analysis-stat-value">${technical.trend?.trend?.toUpperCase() || 'N/A'}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">RSI (14)</span>
                                <span class="analysis-stat-value" style="color: ${
                                    technical.indicators?.rsi > 70 ? '#ef4444' : 
                                    technical.indicators?.rsi < 30 ? '#10b981' : '#1f2937'
                                }">${technical.indicators?.rsi?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">MACD Signal</span>
                                <span class="analysis-stat-value">${
                                    technical.indicators?.macd?.histogram > 0 ? 'üìà Bullish' : 'üìâ Bearish'
                                }</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment -->
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937;">üí≠ Market Sentiment</h4>
                        <div style="display: grid; gap: 10px;">
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Overall</span>
                                <span class="analysis-stat-value" style="color: ${
                                    sentiment.overall?.classification === 'bullish' ? '#10b981' : 
                                    sentiment.overall?.classification === 'bearish' ? '#ef4444' : '#6b7280'
                                }">
                                    ${sentiment.overall?.classification?.toUpperCase() || 'NEUTRAL'}
                                </span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Sentiment Score</span>
                                <span class="analysis-stat-value">${sentiment.overall?.score?.toFixed(3) || '0.000'}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Mention Volume</span>
                                <span class="analysis-stat-value">${sentiment.mentionVolume || 0} posts</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Setup -->
                    ${recommendation.entryPrice ? `
                    <div style="background: #f0fdf4; border-radius: 8px; padding: 20px; border: 2px solid #10b981;">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937;">üéØ Trade Setup</h4>
                        <div style="display: grid; gap: 10px;">
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Entry Price</span>
                                <span class="analysis-stat-value">$${recommendation.entryPrice?.toLocaleString()}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Stop Loss</span>
                                <span class="analysis-stat-value" style="color: #ef4444;">$${recommendation.stopLoss?.toLocaleString()}</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Take Profit Levels</span>
                                <span class="analysis-stat-value" style="color: #10b981;">
                                    ${recommendation.takeProfitLevels?.map(tp => '$' + tp.toLocaleString()).join(', ') || 'N/A'}
                                </span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Position Size</span>
                                <span class="analysis-stat-value">${recommendation.positionSize}% of portfolio</span>
                            </div>
                            <div class="analysis-stat">
                                <span class="analysis-stat-label">Risk Level</span>
                                <span class="analysis-stat-value" style="color: ${
                                    recommendation.riskLevel === 'HIGH' ? '#ef4444' : 
                                    recommendation.riskLevel === 'MEDIUM' ? '#f59e0b' : '#10b981'
                                }">${recommendation.riskLevel}</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Key Factors -->
                    ${recommendation.keyFactors?.length ? `
                    <div style="background: white; border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937;">üîë Key Factors</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${recommendation.keyFactors.map(factor => `<li>${factor}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function closeAnalysis() {
            document.getElementById('analysisResult').style.display = 'none';
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target === modal) {
                closeInfoModal();
            }
        });
    </script>

    <!-- Information Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° Trading Guide & Information</h2>
                <button class="close-button" onclick="closeInfoModal()">√ó</button>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-button active" onclick="switchTab('updates')">‚ú® What's New</button>
                <button class="tab-button" onclick="switchTab('indicators')">üìä Market Indicators</button>
                <button class="tab-button" onclick="switchTab('trading')">üí∞ Trading Tips</button>
                <button class="tab-button" onclick="switchTab('risk')">üõ°Ô∏è Risk Management</button>
                <button class="tab-button" onclick="switchTab('platform')">üöÄ Platform Guide</button>
            </div>
            
            <div class="modal-body">
                <!-- What's New Tab -->
                <div id="updates" class="tab-content active">
                    <div class="info-section">
                        <h3>üéâ Latest Updates - October 10, 2025</h3>
                        
                        <div class="success-box" style="margin-bottom: 20px;">
                            <strong>üõ°Ô∏è Automatic Protection Execution - NEW!</strong><br>
                            Setting stop loss or take profit now auto-executes when levels are reached.
                        </div>

                        <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af;">üîê How Protection Auto-Execution Works</h4>
                            <p style="margin-bottom: 10px;"><strong>Setting a protection level = Pre-authorization to sell</strong></p>
                            <ul style="margin-left: 20px;">
                                <li>‚úÖ When you set a <strong>stop loss</strong> or <strong>take profit</strong> level, you're giving permission</li>
                                <li>‚úÖ The system monitors prices every 5 minutes</li>
                                <li>‚úÖ When your level is reached, it <strong>automatically executes</strong> the sell</li>
                                <li>‚úÖ No manual approval needed - you already decided when you set the level</li>
                                <li>‚úÖ Trade history shows it as "üõ°Ô∏è Stop Loss" or "üéØ Take Profit"</li>
                            </ul>
                            <p style="margin-top: 10px; color: #1e40af;"><strong>üí° Think of it like:</strong> Placing a limit order on an exchange. You've already made the decision - execution is just fulfillment.</p>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #b45309;">üéØ Exit Strategies - NEW!</h4>
                            <p style="margin-bottom: 10px;"><strong>Choose how your positions are closed when take profit is reached</strong></p>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 4px;">
                                <strong style="color: #10b981;">üì§ Full Exit (Default)</strong>
                                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                                    <li>Sells 100% of position when level hit</li>
                                    <li>Simple, clear, locks in all profits</li>
                                    <li><strong>Best for:</strong> Conservative traders, clear targets</li>
                                </ul>
                            </div>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 4px;">
                                <strong style="color: #f59e0b;">üìä Ladder Exit</strong>
                                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                                    <li>Sells 50% each time level is hit</li>
                                    <li>Lets winners run, reduces FOMO</li>
                                    <li><strong>Best for:</strong> Strong trends, high conviction trades</li>
                                    <li><strong>Example:</strong> Hit 1: Sell 50% | Hit 2: Sell 25% | Hit 3: Sell 12.5%...</li>
                                </ul>
                            </div>
                            
                            <p style="margin-top: 10px; font-size: 14px; color: #b45309;">
                                <strong>‚ÑπÔ∏è Note:</strong> Stop losses always sell 100% (risk management priority).<br>
                                <strong>üìö Details:</strong> See <code>EXIT_STRATEGIES.md</code> for full comparison and examples.
                            </p>
                            
                            <div style="margin-top: 12px; padding: 10px; background: #fee2e2; border-radius: 4px; font-size: 13px;">
                                <strong>‚öôÔ∏è How to Set Your Strategy:</strong> Currently requires database update. UI settings coming soon!
                                <pre style="margin: 8px 0; padding: 8px; background: #000; color: #0f0; border-radius: 3px; font-size: 12px; overflow-x: auto;">-- Full Exit (default)
UPDATE user_settings SET take_profit_strategy = 'full' WHERE user_id = 1;

-- Ladder Exit
UPDATE user_settings SET take_profit_strategy = 'partial' WHERE user_id = 1;</pre>
                            </div>
                        </div>

                        <div class="success-box" style="margin-bottom: 20px;">
                            <strong>üöÄ Discovery Strategy System - LIVE!</strong><br>
                            Choose your risk/reward profile for finding trading opportunities.
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Three Discovery Strategies</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #10b981; margin-bottom: 10px;">üõ°Ô∏è Conservative - Safe & Steady</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Established coins (BTC, ETH, top 10-15)</li>
                                <li><strong>Min Market Cap:</strong> $100M (proven projects)</li>
                                <li><strong>Min Volume:</strong> $10M daily (high liquidity)</li>
                                <li><strong>Score Threshold:</strong> 70/100 (quality filter)</li>
                                <li><strong>Best For:</strong> New traders, risk-averse investors</li>
                                <li><strong>Expected:</strong> 70-80% win rate, 20-50% gains per trade</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #3b82f6; margin-bottom: 10px;">‚öñÔ∏è Moderate - Balanced Growth (Default)</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Mix of established + emerging coins</li>
                                <li><strong>Min Market Cap:</strong> $50M (includes mid-caps)</li>
                                <li><strong>Min Volume:</strong> $2M daily (decent liquidity)</li>
                                <li><strong>Score Threshold:</strong> 65/100 (balanced filter)</li>
                                <li><strong>Best For:</strong> Intermediate traders, balanced portfolios</li>
                                <li><strong>Expected:</strong> 60-70% win rate, 30-100% gains per trade</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #ef4444; margin-bottom: 10px;">üöÄ Aggressive - High Risk/Reward</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Target:</strong> Small-caps, emerging trends, moonshots</li>
                                <li><strong>Min Market Cap:</strong> $10M (includes small-caps)</li>
                                <li><strong>Min Volume:</strong> $500K daily (can still trade)</li>
                                <li><strong>Score Threshold:</strong> 60/100 (broader opportunities)</li>
                                <li><strong>Best For:</strong> Experienced traders, speculation</li>
                                <li><strong>Expected:</strong> 40-50% win rate, 100-1000% gains per trade</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üåç Expanded Coin Universe</h3>
                        
                        <p>Now scan up to <strong>top 100 coins</strong> (was limited to top 50):</p>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Top 10 - Blue chips only</li>
                            <li>‚úÖ Top 25 - Quality coins (recommended)</li>
                            <li>‚úÖ Top 50 - Major + large caps</li>
                            <li>‚ú® <strong>NEW: Top 100 - Include mid-caps</strong></li>
                        </ul>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° Pro Tip:</strong> Try "Top 100 + Aggressive" to find hidden gems with strong momentum!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>‚öôÔ∏è How to Use</h3>
                        
                        <p><strong>Quick Access (Discovery Section):</strong></p>
                        <ol style="margin-left: 20px;">
                            <li>Go to "üîç Discovered Opportunities" section</li>
                            <li>Select universe: Top 10/25/50/100</li>
                            <li>Select strategy: Conservative/Moderate/Aggressive</li>
                            <li>Click "üöÄ Run Discovery"</li>
                            <li>See different results based on strategy!</li>
                        </ol>

                        <p style="margin-top: 15px;"><strong>Settings (For Automation):</strong></p>
                        <ol style="margin-left: 20px;">
                            <li>Click ‚öôÔ∏è icon (top-right)</li>
                            <li>Set "Coin Universe" (controls automated discovery)</li>
                            <li>Set "Discovery Strategy" (controls risk profile)</li>
                            <li>Save settings</li>
                            <li>Automated discovery will use your preferences!</li>
                        </ol>
                    </div>

                    <div class="info-section">
                        <h3>üí∞ Manual Trading Widget - NEW!</h3>
                        
                        <div class="success-box" style="margin-bottom: 15px;">
                            <strong>üéâ Now you can execute trades manually with full control!</strong>
                        </div>
                        
                        <p><strong>Features:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ <strong>Quick Trade Entry:</strong> Buy or sell any cryptocurrency</li>
                            <li>‚úÖ <strong>Flexible Amounts:</strong> Enter quantity in units, USD, or % of portfolio</li>
                            <li>‚úÖ <strong>Trade Preview:</strong> See costs, fees, and slippage before executing</li>
                            <li>‚úÖ <strong>Stop-Loss & Take-Profit:</strong> Set protective orders automatically</li>
                            <li>‚úÖ <strong>Real-time Validation:</strong> Instant feedback on invalid inputs</li>
                            <li>‚úÖ <strong>Auto Portfolio Updates:</strong> Holdings refresh after each trade</li>
                        </ul>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° How to use:</strong> Scroll down to the "üí∞ Manual Trading" section, enter a symbol (e.g., ZEC), choose amount, preview, and execute!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üîß Other Recent Improvements</h3>
                        
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ <strong>Sparkline Charts:</strong> See 48-hour price trends in discovery table</li>
                            <li>‚úÖ <strong>Current Prices:</strong> Live prices with 24h change in discoveries</li>
                            <li>‚úÖ <strong>70+ Altcoins Supported:</strong> Including ZEC, XMR, DASH, and more</li>
                            <li>‚úÖ <strong>Dynamic Coin Discovery:</strong> Auto-finds coin IDs for unknown symbols</li>
                            <li>‚úÖ <strong>Force Refresh:</strong> Bypass cache for fresh data</li>
                            <li>‚úÖ <strong>Execution Tracking:</strong> See when discovery last ran</li>
                            <li>‚úÖ <strong>Coinbase Integration:</strong> Replaced Binance for US compliance</li>
                            <li>‚úÖ <strong>RSS News Feeds:</strong> Unlimited news from 5 sources</li>
                            <li>‚úÖ <strong>Optimized Caching:</strong> 97% reduction in API calls</li>
                            <li>‚úÖ <strong>Free Tier Only:</strong> All APIs use free tiers ($0 cost!)</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>üìö Documentation</h3>
                        
                        <p>Detailed plans available in project files:</p>
                        <ul style="margin-left: 20px;">
                            <li><code>MANUAL_TRADING_WORKFLOW.md</code> - Manual trading guide</li>
                            <li><code>DISCOVERY_STRATEGY_PLAN.md</code> - Full strategy documentation</li>
                            <li><code>INTEGRATION_COMPLETE.md</code> - API integration details</li>
                            <li><code>QUICKSTART.md</code> - Getting started guide</li>
                        </ul>
                    </div>
                </div>

                <!-- Market Indicators Tab -->
                <div id="indicators" class="tab-content">
                    <div class="info-section">
                        <h3>üìà BTC Dominance</h3>
                        <p><strong>Source:</strong> CoinGecko API - Global Market Data</p>
                        <p><strong>What it means:</strong> Bitcoin's market cap as a percentage of total cryptocurrency market cap.</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Market State</th>
                                    <th>What It Means</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>&gt; 60%</strong></td>
                                    <td>High Dominance</td>
                                    <td>Bitcoin leading, altcoins underperforming</td>
                                </tr>
                                <tr>
                                    <td><strong>40-60%</strong></td>
                                    <td>Balanced Market</td>
                                    <td>Healthy distribution between BTC and alts</td>
                                </tr>
                                <tr>
                                    <td><strong>&lt; 40%</strong></td>
                                    <td>"Alt Season"</td>
                                    <td>Altcoins outperforming Bitcoin</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="tip-box">
                            <strong>üí° Trading Signal:</strong> Rising BTC dominance = Money flowing INTO Bitcoin (risk-off behavior). Falling dominance = Money flowing INTO altcoins (risk-on behavior).
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Market Regime</h3>
                        <p><strong>Source:</strong> Custom analysis based on 30-day price movements and volatility</p>
                        <p><strong>How it's calculated:</strong> Analyzes BTC price changes, daily ranges, and trend direction</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Regime</th>
                                    <th>Condition</th>
                                    <th>Strategy</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>BULL üêÇ</strong></td>
                                    <td>Price up &gt;10% in 30 days, low volatility</td>
                                    <td>Long positions, momentum trading</td>
                                </tr>
                                <tr>
                                    <td><strong>BEAR üêª</strong></td>
                                    <td>Price down &gt;10% in 30 days</td>
                                    <td>Defensive, short positions, or cash</td>
                                </tr>
                                <tr>
                                    <td><strong>SIDEWAYS ‚ÜîÔ∏è</strong></td>
                                    <td>Price change &lt;10%, consolidating</td>
                                    <td>Range trading, wait for breakout</td>
                                </tr>
                                <tr>
                                    <td><strong>HIGH_VOLATILITY ‚ö°</strong></td>
                                    <td>Daily range &gt;5%</td>
                                    <td>Reduce positions, tight stop-losses</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="info-section">
                        <h3>üíº Risk Sentiment</h3>
                        <p><strong>Source:</strong> Alpha Vantage - Traditional market indicators (S&P 500, Gold, VIX)</p>
                        <p><strong>Why it matters:</strong> Crypto shows ~40-60% correlation with traditional markets</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Sentiment</th>
                                    <th>Indicators</th>
                                    <th>Impact on Crypto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong style="color: #10b981;">RISK-ON</strong></td>
                                    <td>S&P 500 ‚Üë, VIX ‚Üì, Gold ‚Üì</td>
                                    <td>‚úÖ Positive - Investors buying risky assets</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #ef4444;">RISK-OFF</strong></td>
                                    <td>S&P 500 ‚Üì, VIX ‚Üë, Gold ‚Üë</td>
                                    <td>‚ùå Negative - Investors seeking safety</td>
                                </tr>
                                <tr>
                                    <td><strong style="color: #6b7280;">NEUTRAL</strong></td>
                                    <td>Mixed signals</td>
                                    <td>‚ö†Ô∏è Uncertain market direction</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Important:</strong> Risk-off sentiment typically precedes crypto selloffs. Use this as an early warning system.
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìâ VIX (Volatility Index)</h3>
                        <p><strong>Source:</strong> Alpha Vantage - CBOE Volatility Index (^VIX)</p>
                        <p><strong>What it is:</strong> Measures expected 30-day volatility in the S&P 500</p>
                        <p><strong>Nickname:</strong> "The Fear Index"</p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>VIX Level</th>
                                    <th>Market State</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>&lt; 15</strong></td>
                                    <td>üòå Calm, Low Fear</td>
                                    <td>Normal trading operations</td>
                                </tr>
                                <tr>
                                    <td><strong>15-20</strong></td>
                                    <td>üòê Normal Volatility</td>
                                    <td>Monitor market closely</td>
                                </tr>
                                <tr>
                                    <td><strong>20-30</strong></td>
                                    <td>üò∞ Elevated Fear</td>
                                    <td>Reduce position sizes</td>
                                </tr>
                                <tr>
                                    <td><strong>&gt; 30</strong></td>
                                    <td>üò± High Panic</td>
                                    <td>üö® High risk - defensive positions</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="warning-box">
                            <strong>üö® Current Alert:</strong> If VIX > 30, expect increased crypto volatility and potential selloffs. Consider reducing leverage and tightening stop-losses.
                        </div>
                    </div>
                </div>

                <!-- Trading Tips Tab -->
                <div id="trading" class="tab-content">
                    <div class="info-section">
                        <h3>üéØ Core Trading Principles</h3>
                        
                        <div class="success-box">
                            <strong>‚úÖ DO:</strong>
                            <ul>
                                <li>Trade with a plan - know your entry, exit, and stop-loss before trading</li>
                                <li>Use position sizing - never risk more than 1-2% of capital per trade</li>
                                <li>Follow the trend - "The trend is your friend until it ends"</li>
                                <li>Use technical AND fundamental analysis together</li>
                                <li>Keep a trading journal - track what works and what doesn't</li>
                                <li>Wait for confirmation - don't chase pumps</li>
                            </ul>
                        </div>

                        <div class="warning-box">
                            <strong>‚ùå DON'T:</strong>
                            <ul>
                                <li>Trade based on emotions (FOMO, panic)</li>
                                <li>Risk money you can't afford to lose</li>
                                <li>Ignore stop-losses - they're your safety net</li>
                                <li>Overtrade - quality over quantity</li>
                                <li>Average down on losing positions</li>
                                <li>Trade without understanding why</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìä Technical Analysis Tips</h3>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Indicator</th>
                                    <th>Best Use</th>
                                    <th>Signal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>RSI (14)</strong></td>
                                    <td>Overbought/Oversold</td>
                                    <td>&gt;70 = Overbought, &lt;30 = Oversold</td>
                                </tr>
                                <tr>
                                    <td><strong>MACD</strong></td>
                                    <td>Trend & Momentum</td>
                                    <td>Line crosses = Trend changes</td>
                                </tr>
                                <tr>
                                    <td><strong>Bollinger Bands</strong></td>
                                    <td>Volatility & Breakouts</td>
                                    <td>Price at edges = Reversal or breakout</td>
                                </tr>
                                <tr>
                                    <td><strong>Volume</strong></td>
                                    <td>Confirm Trends</td>
                                    <td>Rising volume = Strong move</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="tip-box">
                            <strong>üí° Pro Tip:</strong> No single indicator is perfect. Use multiple indicators together for confirmation. If RSI, MACD, and trend all align - that's a strong signal!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üéØ Entry & Exit Strategies</h3>
                        
                        <p><strong>Best Entry Signals:</strong></p>
                        <ul>
                            <li>‚úÖ Price bounces off support + RSI oversold</li>
                            <li>‚úÖ MACD crossover + bullish candle pattern</li>
                            <li>‚úÖ Breakout above resistance with high volume</li>
                            <li>‚úÖ Positive market regime + risk-on sentiment</li>
                        </ul>

                        <p><strong>Exit Signals (Protect Profits):</strong></p>
                        <ul>
                            <li>üéØ Take partial profits at +20%, +50%, +100%</li>
                            <li>üéØ Trail stop-loss as price rises</li>
                            <li>üéØ Exit when indicators turn bearish</li>
                            <li>üéØ Exit when market regime changes to bearish</li>
                        </ul>
                    </div>
                </div>

                <!-- Risk Management Tab -->
                <div id="risk" class="tab-content">
                    <div class="info-section">
                        <h3>üõ°Ô∏è Position Sizing Formula</h3>
                        
                        <div class="success-box">
                            <strong>Safe Position Size =</strong><br>
                            (Account Size √ó Risk %) √∑ (Entry Price - Stop Loss Price)<br><br>
                            <strong>Example:</strong><br>
                            - Account: $10,000<br>
                            - Risk per trade: 2% = $200<br>
                            - Entry: $50,000<br>
                            - Stop Loss: $48,000<br>
                            - Position Size: $200 √∑ $2,000 = 0.1 BTC
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Golden Rules:</strong>
                            <ul>
                                <li>Never risk more than 2% per trade</li>
                                <li>Maximum 20% total portfolio risk at once</li>
                                <li>Larger position = Tighter stop-loss</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üìâ Stop-Loss Strategies</h3>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>When to Use</th>
                                    <th>How to Set</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Fixed %</strong></td>
                                    <td>Volatile assets</td>
                                    <td>5-10% below entry</td>
                                </tr>
                                <tr>
                                    <td><strong>Support Level</strong></td>
                                    <td>Trending markets</td>
                                    <td>Just below key support</td>
                                </tr>
                                <tr>
                                    <td><strong>ATR-Based</strong></td>
                                    <td>Any market</td>
                                    <td>2-3√ó ATR below entry</td>
                                </tr>
                                <tr>
                                    <td><strong>Trailing</strong></td>
                                    <td>Strong trends</td>
                                    <td>Move up as price rises</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="info-section">
                        <h3>‚öñÔ∏è Risk/Reward Ratios</h3>
                        
                        <div class="tip-box">
                            <strong>üí° Minimum Ratios:</strong><br>
                            - Conservative: 1:3 (Risk $100 to make $300)<br>
                            - Moderate: 1:2 (Risk $100 to make $200)<br>
                            - Never take trades below 1:1.5 ratio<br><br>
                            
                            <strong>Why it matters:</strong> With a 1:3 ratio, you only need 33% win rate to be profitable!
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>üö® When to Reduce Risk</h3>
                        <ul>
                            <li>‚ùå VIX above 30 - High market fear</li>
                            <li>‚ùå Market regime = HIGH_VOLATILITY</li>
                            <li>‚ùå Risk sentiment = RISK-OFF</li>
                            <li>‚ùå Multiple losing trades in a row</li>
                            <li>‚ùå BTC dominance rapidly changing</li>
                            <li>‚ùå Low volume / low liquidity periods</li>
                        </ul>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Defense Mode:</strong> When 2+ risk factors are present, reduce position sizes by 50% or move to cash. Preservation of capital is the #1 priority.
                        </div>
                    </div>
                </div>

                <!-- Platform Guide Tab -->
                <div id="platform" class="tab-content">
                    <div class="info-section">
                        <h3>üéÆ How to Use This Platform</h3>
                        
                        <p><strong>Current Features:</strong></p>
                        <ul>
                            <li>‚úÖ Real-time market data from multiple sources</li>
                            <li>‚úÖ AI-powered trade recommendations</li>
                            <li>‚úÖ Portfolio tracking ($10,000 starting capital)</li>
                            <li>‚úÖ Technical indicator analysis</li>
                            <li>‚úÖ Sentiment analysis (Reddit + News)</li>
                            <li>‚úÖ Market context monitoring</li>
                            <li>‚úÖ Paper trading (virtual money only)</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <h3>üìä Dashboard Sections Explained</h3>
                        
                        <p><strong>Portfolio Overview:</strong> Your virtual account balance, positions, and returns</p>
                        
                        <p><strong>Performance Metrics:</strong></p>
                        <ul>
                            <li><strong>Sharpe Ratio:</strong> Risk-adjusted returns (&gt;1 is good)</li>
                            <li><strong>Max Drawdown:</strong> Largest peak-to-trough decline</li>
                            <li><strong>Win Rate:</strong> Percentage of profitable trades</li>
                        </ul>

                        <p><strong>Market Context:</strong> Real-time macro indicators affecting crypto</p>
                        
                        <p><strong>AI Recommendations:</strong> Machine learning-powered trade suggestions</p>
                    </div>

                    <div class="info-section">
                        <h3>üîÑ Data Sources</h3>
                        
                        <p style="margin-bottom: 15px; color: #6b7280;">
                            <strong>All data sources use free tiers</strong> - No API costs! Optimized with aggressive caching to stay within rate limits.
                        </p>
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Data Type</th>
                                    <th>Rate Limit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ü™ô Coinbase</strong></td>
                                    <td>Candlesticks, OHLC, Order Book, Real-time Prices</td>
                                    <td>10,000/hour</td>
                                </tr>
                                <tr>
                                    <td><strong>ü¶é CoinGecko</strong></td>
                                    <td>Market Cap, Dominance, Coin Rankings</td>
                                    <td>50/min</td>
                                </tr>
                                <tr>
                                    <td><strong>üì∞ CryptoCompare</strong></td>
                                    <td>News Articles, Sentiment (Votes)</td>
                                    <td>3,000/month</td>
                                </tr>
                                <tr>
                                    <td><strong>üì° RSS Feeds</strong></td>
                                    <td>News (CoinDesk, CoinTelegraph, Decrypt, Bitcoin Magazine, The Block)</td>
                                    <td>Unlimited</td>
                                </tr>
                                <tr>
                                    <td><strong>üó£Ô∏è Reddit</strong></td>
                                    <td>Social Sentiment, Community Discussion</td>
                                    <td>60/min</td>
                                </tr>
                                <tr>
                                    <td><strong>üìà Alpha Vantage</strong></td>
                                    <td>Traditional Markets (S&P 500, VIX, Gold)</td>
                                    <td>25/day</td>
                                </tr>
                                <tr>
                                    <td><strong>ü§ñ OpenAI/Anthropic</strong></td>
                                    <td>AI Analysis & Trade Recommendations</td>
                                    <td>On-demand</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="tip-box" style="margin-top: 15px;">
                            <strong>üí° Recent Updates:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>Replaced Binance ‚Üí Coinbase</strong> - More reliable US access</li>
                                <li><strong>Added CryptoCompare News</strong> - Vote-based sentiment analysis</li>
                                <li><strong>Added 5 RSS feeds</strong> - Unlimited news coverage</li>
                                <li><strong>Optimized caching</strong> - 97% reduction in API calls</li>
                                <li><strong>Disabled CryptoPanic</strong> - Exceeded free tier, replaced with better sources</li>
                            </ul>
                        </div>
                        
                        <div class="success-box" style="margin-top: 15px;">
                            <strong>‚úÖ Sentiment Analysis Method:</strong><br>
                            Uses <strong>lexicon-based analysis</strong> (not AI) with crypto-specific keywords:
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><strong>Speed:</strong> &lt;1ms per article (vs 1-3s for AI)</li>
                                <li><strong>Cost:</strong> $0 (vs $0.075 per 50 articles with GPT-4)</li>
                                <li><strong>Sources weighted:</strong> CoinDesk (1.0), CoinTelegraph (0.95), etc.</li>
                                <li><strong>Multi-source:</strong> Title (60%) + Content (40%) + Votes</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>‚ö†Ô∏è Important Disclaimers</h3>
                        
                        <div class="warning-box">
                            <strong>üö® Paper Trading Only:</strong><br>
                            This platform uses VIRTUAL MONEY only. No real cryptocurrency is bought or sold. This is for learning and testing strategies only.
                        </div>

                        <div class="tip-box">
                            <strong>üí° Best Practices:</strong>
                            <ul>
                                <li>Treat virtual money as real - take it seriously</li>
                                <li>Test different strategies</li>
                                <li>Learn from mistakes without financial risk</li>
                                <li>Build confidence before real trading</li>
                                <li>Track your decision-making process</li>
                            </ul>
                        </div>

                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Not Financial Advice:</strong><br>
                            This platform provides educational information and analysis tools. All recommendations are for educational purposes only. Always do your own research and consult with financial advisors before making real investment decisions.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Your Settings</h2>
                <button class="close-button" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <!-- Auto-Trading Settings -->
                <div class="info-section">
                    <h3>ü§ñ Auto-Trading</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Enable Auto-Execution</h4>
                            <p>Automatically execute trades when AI confidence exceeds threshold</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoExecuteToggle" onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Confidence Threshold</h4>
                            <p>Minimum AI confidence required for auto-execution</p>
                        </div>
                        <div class="setting-control">
                            <div class="range-slider">
                                <input type="range" id="confidenceThreshold" min="70" max="90" step="5" value="75" oninput="updateConfidenceValue(this.value)" onchange="saveSettings()">
                                <div class="range-value"><span id="confidenceValue">75</span>%</div>
                            </div>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Human-in-the-Loop</h4>
                            <p>Require manual approval before executing trades</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="humanApprovalToggle" checked onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Position Sizing -->
                <div class="info-section">
                    <h3>üí∞ Capital Allocation</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Position Sizing Strategy</h4>
                            <p>How to calculate position size for new trades</p>
                        </div>
                        <div class="setting-control">
                            <select id="positionSizingStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="equal">Equal Weight - Same size for all positions</option>
                                <option value="confidence">Confidence-Based - Size by AI confidence</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Maximum Position Size</h4>
                            <p>Maximum % of portfolio per single position</p>
                        </div>
                        <div class="setting-control">
                            <div class="range-slider">
                                <input type="range" id="maxPositionSize" min="2" max="10" step="1" value="5" oninput="updateMaxPositionValue(this.value)" onchange="saveSettings()">
                                <div class="range-value"><span id="maxPositionValue">5</span>%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exit Strategy -->
                <div class="info-section">
                    <h3>üéØ Exit Strategy</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Take Profit Strategy</h4>
                            <p>How to handle reaching profit targets</p>
                        </div>
                        <div class="setting-control">
                            <select id="takeProfitStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="full">Full Exit - Close entire position at target</option>
                                <option value="partial">Partial Exit - Close 50% at first target</option>
                                <option value="trailing">Trailing Stop - Follow price upward</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Auto Stop-Loss</h4>
                            <p>Automatically exit when stop-loss is hit</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoStopLossToggle" checked onchange="saveSettings()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Market Focus -->
                <div class="info-section">
                    <h3>üéØ Market Focus</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Coin Universe</h4>
                            <p>Which cryptocurrencies to analyze and trade</p>
                        </div>
                        <div class="setting-control">
                            <select id="coinUniverse" class="setting-select" onchange="saveSettings()">
                                <option value="top10">Top 10 - BTC, ETH, BNB, etc.</option>
                                <option value="top25" selected>Top 25 - Quality coins (recommended)</option>
                                <option value="top50">Top 50 - Major coins + large caps</option>
                                <option value="top100">Top 100 - Include mid-caps</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Discovery Strategy</h4>
                            <p>Risk/reward profile for finding opportunities</p>
                        </div>
                        <div class="setting-control">
                            <select id="discoveryStrategy" class="setting-select" onchange="saveSettings()">
                                <option value="conservative">üõ°Ô∏è Conservative - Safe & Steady</option>
                                <option value="moderate" selected>‚öñÔ∏è Moderate - Balanced Growth</option>
                                <option value="aggressive">üöÄ Aggressive - High Risk/Reward</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Analysis Frequency</h4>
                            <p>How often to generate new AI recommendations</p>
                        </div>
                        <div class="setting-control">
                            <select id="analysisFrequency" class="setting-select" onchange="saveSettings()">
                                <option value="1">Every 1 Hour (High cost)</option>
                                <option value="4" selected>Every 4 Hours (Recommended)</option>
                                <option value="8">Every 8 Hours (Low cost)</option>
                                <option value="24">Daily (Minimal cost)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Warning Box -->
                <div class="warning-box" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Auto-Trading Risk Warning:</strong><br>
                    Enabling auto-execution means trades will be placed automatically based on AI recommendations. While convenient, this removes human oversight and could result in unexpected losses. Start with small position sizes and monitor closely.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Settings Management
        const DEFAULT_SETTINGS = {
            autoExecute: false,
            confidenceThreshold: 75,
            humanApproval: true,
            positionSizingStrategy: 'equal',
            maxPositionSize: 5,
            takeProfitStrategy: 'partial',
            autoStopLoss: true,
            coinUniverse: 'top25',
            discoveryStrategy: 'moderate',
            analysisFrequency: 4
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('tradingSettings');
            return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : DEFAULT_SETTINGS;
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                autoExecute: document.getElementById('autoExecuteToggle').checked,
                confidenceThreshold: parseInt(document.getElementById('confidenceThreshold').value),
                humanApproval: document.getElementById('humanApprovalToggle').checked,
                positionSizingStrategy: document.getElementById('positionSizingStrategy').value,
                maxPositionSize: parseInt(document.getElementById('maxPositionSize').value),
                takeProfitStrategy: document.getElementById('takeProfitStrategy').value,
                autoStopLoss: document.getElementById('autoStopLossToggle').checked,
                coinUniverse: document.getElementById('coinUniverse').value,
                discoveryStrategy: document.getElementById('discoveryStrategy').value,
                analysisFrequency: parseInt(document.getElementById('analysisFrequency').value)
            };
            
            localStorage.setItem('tradingSettings', JSON.stringify(settings));
            console.log('Settings saved:', settings);
            
            // Sync with discovery dropdowns
            const universeSelectEl = document.getElementById('discoveryUniverseSelect');
            const strategySelectEl = document.getElementById('discoveryStrategySelect');
            if (universeSelectEl) universeSelectEl.value = settings.coinUniverse;
            if (strategySelectEl) strategySelectEl.value = settings.discoveryStrategy;
        }

        // Apply saved settings to UI
        function applySettings() {
            const settings = loadSettings();
            
            document.getElementById('autoExecuteToggle').checked = settings.autoExecute;
            document.getElementById('confidenceThreshold').value = settings.confidenceThreshold;
            document.getElementById('confidenceValue').textContent = settings.confidenceThreshold;
            document.getElementById('humanApprovalToggle').checked = settings.humanApproval;
            document.getElementById('positionSizingStrategy').value = settings.positionSizingStrategy;
            document.getElementById('maxPositionSize').value = settings.maxPositionSize;
            document.getElementById('maxPositionValue').textContent = settings.maxPositionSize;
            document.getElementById('takeProfitStrategy').value = settings.takeProfitStrategy;
            document.getElementById('autoStopLossToggle').checked = settings.autoStopLoss;
            document.getElementById('coinUniverse').value = settings.coinUniverse;
            document.getElementById('discoveryStrategy').value = settings.discoveryStrategy;
            document.getElementById('analysisFrequency').value = settings.analysisFrequency;
        }

        // Update confidence value display
        function updateConfidenceValue(value) {
            document.getElementById('confidenceValue').textContent = value;
        }

        // Update max position value display
        function updateMaxPositionValue(value) {
            document.getElementById('maxPositionValue').textContent = value;
        }

        // Settings modal functions
        function openSettingsModal() {
            applySettings(); // Load current settings
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveAndCloseSettings() {
            saveSettings();
            closeSettingsModal();
            
            // Show success message
            alert('‚úÖ Settings saved successfully!');
        }

        // Initialize settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            applySettings();
            loadDiscoverySettings();  // Load user's discovery preferences into dropdowns
        });

        // Get current settings (for use in other functions)
        function getSettings() {
            return loadSettings();
        }

        // Save discovery settings from dropdowns (sync with main settings)
        function saveDiscoverySettings() {
            const settings = loadSettings();
            settings.coinUniverse = document.getElementById('discoveryUniverseSelect').value;
            settings.discoveryStrategy = document.getElementById('discoveryStrategySelect').value;
            localStorage.setItem('tradingSettings', JSON.stringify(settings));
            
            // Also update settings modal if it exists
            const coinUniverseEl = document.getElementById('coinUniverse');
            const discoveryStrategyEl = document.getElementById('discoveryStrategy');
            if (coinUniverseEl) coinUniverseEl.value = settings.coinUniverse;
            if (discoveryStrategyEl) discoveryStrategyEl.value = settings.discoveryStrategy;
        }

        // Load discovery settings into dropdowns
        function loadDiscoverySettings() {
            const settings = loadSettings();
            document.getElementById('discoveryUniverseSelect').value = settings.coinUniverse || 'top25';
            document.getElementById('discoveryStrategySelect').value = settings.discoveryStrategy || 'moderate';
        }

        // Discovery Functions
        async function runDiscovery() {
            const btn = document.getElementById('discoveryBtn');
            const status = document.getElementById('discovery-status');
            const message = document.getElementById('discovery-message');
            const listDiv = document.getElementById('discoveries-list');
            const logContainer = document.getElementById('analysis-log-container');
            const logContent = document.getElementById('analysis-log-content');
            const logSummary = document.getElementById('log-summary');
            const forceRefresh = document.getElementById('forceRefreshCheckbox').checked;
            const discoveryInfo = document.getElementById('discovery-info');
            
            try {
                // Get coin universe from settings
                const settings = getSettings();
                const universe = settings.coinUniverse || 'top25';
                const strategy = settings.discoveryStrategy || 'moderate';
                
                // Show loading
                btn.disabled = true;
                btn.textContent = '‚è≥ Scanning...';
                status.style.display = 'block';
                const refreshText = forceRefresh ? ' (bypassing cache)' : '';
                const universeText = universe === 'top10' ? 'top 10' : universe === 'top25' ? 'top 25' : universe === 'top50' ? 'top 50' : 'top 100';
                const strategyText = strategy === 'conservative' ? '(Conservative)' : strategy === 'aggressive' ? '(Aggressive)' : '(Moderate)';
                message.textContent = `Scanning ${universeText} coins ${strategyText}${refreshText}...`;
                
                // Clear previous log
                logContent.innerHTML = '';
                logContainer.style.display = 'none';
                
                // Run discovery
                const url = `${API_BASE}/discover?universe=${universe}&strategy=${strategy}${forceRefresh ? '&forceRefresh=true' : ''}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Discovery failed');
                }
                
                const data = await response.json();
                
                // Hide loading, show results
                status.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'üöÄ Run Discovery';
                
                // Update discovery info
                if (data.timestamp) {
                    discoveryInfo.style.display = 'block';
                    const timestamp = new Date(data.timestamp);
                    document.getElementById('discovery-timestamp').textContent = timestamp.toLocaleString();
                    document.getElementById('discovery-execution-time').textContent = `${(data.executionTime / 1000).toFixed(2)}s`;
                    document.getElementById('discovery-cache-status').textContent = data.forceRefresh ? '‚ùå No (Fresh data)' : '‚úÖ Yes (Cached)';
                }
                
                // Show analysis log
                if (data.analysisLog && data.analysisLog.length > 0) {
                    logContainer.style.display = 'block';
                    logSummary.textContent = `${data.summary.totalAnalyzed} analyzed ¬∑ ${data.summary.passed} passed ¬∑ ${data.summary.rejected} rejected`;
                    displayAnalysisLog(data.analysisLog, data.summary);
                }
                
                // Display results
                if (data.candidates && data.candidates.length > 0) {
                    listDiv.innerHTML = formatDiscoveries(data.candidates);
                } else {
                    listDiv.innerHTML = formatNoOpportunities(data.summary, data.analysisLog);
                }
                
            } catch (error) {
                console.error('Discovery error:', error);
                status.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'üöÄ Run Discovery';
                listDiv.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">‚ùå Discovery failed. Please try again.</p>';
            }
        }

        function formatNoOpportunities(summary, analysisLog) {
            return `
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üòî</div>
                    <h3 style="color: #374151; margin-bottom: 10px;">No Opportunities Found</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Analyzed ${summary.totalAnalyzed} coins, but none met the criteria.
                    </p>
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
                        <h4 style="color: #374151; margin-bottom: 15px;">üìä Top Rejection Reasons:</h4>
                        ${summary.topRejectionReasons.map((r, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: ${i < summary.topRejectionReasons.length - 1 ? '1px solid #e5e7eb' : 'none'};">
                                <span style="color: #6b7280;">${r.reason}</span>
                                <span style="font-weight: 600; color: #374151;">${r.count} coins</span>
                            </div>
                        `).join('')}
                    </div>

                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 4px; margin: 20px 0; text-align: left;">
                        <strong style="color: #92400e;">üí° Suggestions:</strong>
                        <ul style="margin: 10px 0 0 20px; color: #78350f;">
                            <li>Market conditions may be unfavorable right now</li>
                            <li>Try expanding to "Top 100" in settings</li>
                            <li>Check back later when market activity increases</li>
                            <li>Review the analysis log below for detailed reasons</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function displayAnalysisLog(analysisLog, summary) {
            const logContent = document.getElementById('analysis-log-content');
            
            const html = `
                <div style="padding: 15px;">
                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 24px; font-weight: 600; color: #3b82f6;">${summary.totalAnalyzed}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Total Analyzed</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 24px; font-weight: 600; color: #10b981;">${summary.passed}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Passed</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 24px; font-weight: 600; color: #ef4444;">${summary.rejected}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Rejected</div>
                        </div>
                    </div>

                    <!-- Log Entries -->
                    <div style="background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                        ${analysisLog.map((entry, index) => `
                            <div style="padding: 12px; border-bottom: ${index < analysisLog.length - 1 ? '1px solid #f3f4f6' : 'none'}; ${entry.passed ? 'background: #f0fdf4;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                    <div>
                                        <strong style="color: #1f2937; font-size: 15px;">
                                            ${entry.symbol}
                                        </strong>
                                        <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">
                                            ${entry.name} ¬∑ Rank #${entry.rank}
                                        </span>
                                    </div>
                                    <span style="font-size: 11px; color: #9ca3af;">
                                        ${new Date(entry.timestamp).toLocaleTimeString()}
                                    </span>
                                </div>
                                <div style="color: ${entry.passed ? '#059669' : '#6b7280'}; font-size: 13px; margin-bottom: 8px;">
                                    ${entry.reason}
                                </div>
                                ${entry.details && Object.keys(entry.details).length > 0 ? `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 12px; color: #6b7280;">
                                        ${entry.details.volumeScore !== undefined ? `
                                            <div>Vol Score: <strong>${entry.details.volumeScore.toFixed(0)}</strong></div>
                                        ` : ''}
                                        ${entry.details.momentumScore !== undefined ? `
                                            <div>Momentum: <strong>${entry.details.momentumScore.toFixed(0)}</strong></div>
                                        ` : ''}
                                        ${entry.details.sentimentScore !== undefined ? `
                                            <div>Sentiment: <strong>${entry.details.sentimentScore.toFixed(0)}</strong></div>
                                        ` : ''}
                                        ${entry.compositeScore !== undefined ? `
                                            <div>Composite: <strong style="color: ${getScoreColor(entry.compositeScore)};">${entry.compositeScore.toFixed(0)}</strong></div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            logContent.innerHTML = html;
        }

        function toggleAnalysisLog() {
            const content = document.getElementById('analysis-log-content');
            const toggle = document.getElementById('log-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        function formatDiscoveries(discoveries) {
            // Calculate discovery age for freshness badge
            let freshnessHTML = '';
            if (discoveries.length > 0 && discoveries[0].discoveredAt) {
                const discoveredAt = new Date(discoveries[0].discoveredAt);
                const now = new Date();
                const ageMinutes = Math.floor((now - discoveredAt) / (1000 * 60));
                const ageHours = Math.floor(ageMinutes / 60);
                
                let badgeColor, badgeText, warningHTML = '';
                
                if (ageHours < 2) {
                    // Fresh (0-2 hours)
                    badgeColor = '#10b981';
                    badgeText = `‚úÖ Fresh (${ageMinutes < 60 ? ageMinutes + ' min' : ageHours + 'h'} ago)`;
                } else if (ageHours < 4) {
                    // Recent (2-4 hours)
                    badgeColor = '#f59e0b';
                    badgeText = `‚ö†Ô∏è Recent (${ageHours}h ago)`;
                    warningHTML = '<div style="padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; margin-bottom: 15px; color: #92400e; font-size: 13px;">‚ö†Ô∏è Discovery data is a few hours old. Consider running a fresh discovery for current opportunities.</div>';
                } else if (ageHours < 6) {
                    // Stale (4-6 hours)
                    badgeColor = '#ef4444';
                    badgeText = `üïê Stale (${ageHours}h ago)`;
                    warningHTML = '<div style="padding: 10px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; margin-bottom: 15px; color: #991b1b; font-size: 13px;">üïê <strong>Data is stale.</strong> Market conditions may have changed significantly. Run discovery for current opportunities.</div>';
                } else {
                    // Very stale (6+ hours)
                    badgeColor = '#6b7280';
                    badgeText = `‚ùå Expired (${ageHours}h ago)`;
                    warningHTML = '<div style="padding: 10px; background: #f3f4f6; border: 1px solid #6b7280; border-radius: 6px; margin-bottom: 15px; color: #374151; font-size: 13px;">‚ùå <strong>Data has expired.</strong> These opportunities are outdated. Please run discovery to find current opportunities.</div>';
                }
                
                freshnessHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span style="padding: 6px 12px; background: ${badgeColor}; color: white; border-radius: 6px; font-size: 13px; font-weight: 600;">
                            ${badgeText}
                        </span>
                    </div>
                    ${warningHTML}
                `;
            }
            
            return `
                ${freshnessHTML}
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 12px; text-align: left;">Rank</th>
                            <th style="padding: 12px; text-align: left;">Symbol</th>
                            <th style="padding: 12px; text-align: left;">Name</th>
                            <th style="padding: 12px; text-align: right;">Price</th>
                            <th style="padding: 12px; text-align: center;">7D Chart</th>
                            <th style="padding: 12px; text-align: right;">Score</th>
                            <th style="padding: 12px; text-align: right;">Volume 24h</th>
                            <th style="padding: 12px; text-align: right;">Market Cap</th>
                            <th style="padding: 12px; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${discoveries.map((coin, index) => `
                            <tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
                                <td style="padding: 12px;">
                                    <span style="font-weight: 600; color: ${index < 3 ? '#667eea' : '#6b7280'};">
                                        #${index + 1}
                                    </span>
                                </td>
                                <td style="padding: 12px;">
                                    <strong style="color: #1f2937; font-size: 16px;">${coin.symbol}</strong>
                                </td>
                                <td style="padding: 12px; color: #6b7280;">${coin.name}</td>
                                <td style="padding: 12px; text-align: right;">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <span style="font-weight: 600; color: #1f2937;">$${formatPrice(coin.currentPrice)}</span>
                                        <span style="font-size: 12px; color: ${coin.priceChange24h >= 0 ? '#10b981' : '#ef4444'};">
                                            ${coin.priceChange24h >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(coin.priceChange24h).toFixed(2)}%
                                        </span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    ${renderSparkline(coin.sparkline, coin.priceChange7d)}
                                </td>
                                <td style="padding: 12px; text-align: right;">
                                    <div style="display: flex; align-items: center; justify-content: flex-end;">
                                        <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; margin-right: 8px;">
                                            <div style="width: ${coin.compositeScore}%; height: 100%; background: ${getScoreColor(coin.compositeScore)}; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-weight: 600; color: ${getScoreColor(coin.compositeScore)};">${Math.round(coin.compositeScore)}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: right; color: #6b7280;">
                                    $${formatNumber(coin.volume24h)}
                                </td>
                                <td style="padding: 12px; text-align: right; color: #6b7280;">
                                    $${formatNumber(coin.marketCap)}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <button class="button" style="padding: 6px 12px; font-size: 13px;" onclick="analyzeDiscovered('${coin.symbol}')">
                                        Analyze
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 15px; padding: 12px; background: #f9fafb; border-radius: 6px; text-align: center; color: #6b7280; font-size: 14px;">
                    <strong>üí° Tip:</strong> 
                    Price shows current value + 24h change. Chart shows last 48 hours of price movement.
                </div>
            `;
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10b981'; // Green
            if (score >= 60) return '#f59e0b'; // Orange
            return '#6b7280'; // Gray
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function formatPrice(price) {
            if (price >= 1000) return price.toFixed(0);
            if (price >= 1) return price.toFixed(2);
            if (price >= 0.01) return price.toFixed(4);
            if (price >= 0.0001) return price.toFixed(6);
            return price.toFixed(8);
        }

        function renderSparkline(sparkline, priceChange) {
            if (!sparkline || sparkline.length === 0) {
                return '<span style="color: #9ca3af; font-size: 12px;">No data</span>';
            }

            // Take last 48 hours (sparkline has 168 points for 7 days, so last ~48 points for 2 days)
            const data = sparkline.slice(-48);
            
            const width = 80;
            const height = 30;
            const padding = 2;
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            
            // Create SVG path
            const points = data.map((value, index) => {
                const x = (index / (data.length - 1)) * (width - padding * 2) + padding;
                const y = height - padding - ((value - min) / range) * (height - padding * 2);
                return `${x},${y}`;
            }).join(' ');
            
            const color = priceChange >= 0 ? '#10b981' : '#ef4444';
            
            return `
                <svg width="${width}" height="${height}" style="display: inline-block;">
                    <polyline
                        points="${points}"
                        fill="none"
                        stroke="${color}"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                </svg>
            `;
        }

        function analyzeDiscovered(symbol) {
            // Set the symbol in the search box
            document.getElementById('cryptoSearch').value = symbol;
            // Scroll to crypto selector
            document.querySelector('.crypto-selector').scrollIntoView({ behavior: 'smooth' });
            // Trigger analysis
            setTimeout(() => analyzeCrypto(), 500);
        }

        // Load top discoveries on page load
        async function loadTopDiscoveries() {
            try {
                const response = await fetch(`${API_BASE}/discover/top?limit=10`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.discoveries && data.discoveries.length > 0) {
                        document.getElementById('discoveries-list').innerHTML = formatDiscoveries(data.discoveries);
                    }
                }
            } catch (error) {
                console.log('No saved discoveries yet');
            }
        }

        // ============================================
        // MANUAL TRADING FUNCTIONS
        // ============================================
        
        let selectedTradeAction = 'BUY'; // Manual trading is always BUY (SELL done in holdings)

        function toggleAdvancedOptions() {
            const checkbox = document.getElementById('addStopLoss');
            const options = document.getElementById('advancedOptions');
            options.style.display = checkbox.checked ? 'block' : 'none';
        }

        function updateQuantityPlaceholder() {
            const type = document.getElementById('quantityType').value;
            const input = document.getElementById('manualTradeQuantity');
            const helper = document.getElementById('quantityHelper');
            
            if (type === 'units') {
                input.placeholder = 'Enter number of coins';
                helper.textContent = 'Example: 0.5 BTC';
            } else if (type === 'usd') {
                input.placeholder = 'Enter dollar amount';
                helper.textContent = 'Example: $1000';
            } else if (type === 'percent') {
                input.placeholder = 'Enter percentage';
                helper.textContent = 'Example: 5 (for 5% of portfolio)';
            }
        }

        async function previewTrade() {
            const symbol = document.getElementById('manualTradeSymbol').value.toUpperCase().trim();
            const quantity = parseFloat(document.getElementById('manualTradeQuantity').value);
            const quantityType = document.getElementById('quantityType').value;
            const addStopLoss = document.getElementById('addStopLoss').checked;
            const stopLossPrice = addStopLoss ? parseFloat(document.getElementById('stopLossPrice').value) : null;
            const takeProfitPrice = addStopLoss ? parseFloat(document.getElementById('takeProfitPrice').value) : null;
            
            const previewArea = document.getElementById('tradePreviewArea');
            
            if (!symbol || !quantity || quantity <= 0) {
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ö†Ô∏è Please enter a valid symbol and quantity
                    </div>
                `;
                return;
            }
            
            if (addStopLoss && (!stopLossPrice || stopLossPrice <= 0)) {
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ö†Ô∏è Please enter a valid stop-loss price
                    </div>
                `;
                return;
            }
            
            try {
                // Show loading state
                previewArea.style.display = 'block';
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; color: #1e40af;">
                        üìä Calculating trade preview...
                    </div>
                `;
                
                // Get current price
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) {
                    throw new Error('Could not fetch price for ' + symbol);
                }
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;
                
                // Get portfolio for percentage calculations
                let actualQuantity = quantity;
                if (quantityType === 'usd') {
                    actualQuantity = quantity / currentPrice;
                } else if (quantityType === 'percent') {
                    const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                    const portfolio = await portfolioResponse.json();
                    const portfolioValue = portfolio.totalValue;
                    const usdAmount = (portfolioValue * quantity) / 100;
                    actualQuantity = usdAmount / currentPrice;
                }
                
                // Calculate costs
                const subtotal = actualQuantity * currentPrice;
                const fee = subtotal * 0.001; // 0.1% fee
                const slippage = subtotal * 0.0005; // 0.05% slippage estimate
                
                let total;
                if (selectedTradeAction === 'BUY') {
                    total = subtotal + fee + slippage;
                } else {
                    total = subtotal - fee - slippage;
                }
                
                // Calculate stop-loss and take-profit percentages if provided
                let stopLossPercent = null;
                let takeProfitPercent = null;
                if (stopLossPrice && selectedTradeAction === 'BUY') {
                    stopLossPercent = ((stopLossPrice - currentPrice) / currentPrice) * 100;
                }
                if (takeProfitPrice && selectedTradeAction === 'BUY') {
                    takeProfitPercent = ((takeProfitPrice - currentPrice) / currentPrice) * 100;
                }
                
                // Show preview with execute button
                previewArea.innerHTML = `
                    <div style="padding: 20px; background: ${selectedTradeAction === 'BUY' ? '#d1fae5' : '#fee2e2'}; border: 2px solid ${selectedTradeAction === 'BUY' ? '#10b981' : '#ef4444'}; border-radius: 8px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 5px 0; color: #1f2937;">üìä Trade Preview</h3>
                            <div style="font-size: 24px; font-weight: 700; color: ${selectedTradeAction === 'BUY' ? '#10b981' : '#ef4444'};">
                                ${selectedTradeAction} ${symbol}
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="display: grid; gap: 10px; font-size: 14px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Quantity:</span>
                                    <strong>${actualQuantity.toFixed(8)} ${symbol}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Current Price:</span>
                                    <strong>$${currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}</strong>
                                </div>
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Subtotal:</span>
                                    <span>$${subtotal.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Fee (0.1%):</span>
                                    <span>$${fee.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Est. Slippage:</span>
                                    <span>$${slippage.toFixed(2)}</span>
                                </div>
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; font-size: 16px;">
                                    <strong>${selectedTradeAction === 'BUY' ? 'Total Cost:' : 'Total Proceeds:'}</strong>
                                    <strong style="color: ${selectedTradeAction === 'BUY' ? '#ef4444' : '#10b981'};">$${total.toFixed(2)}</strong>
                                </div>
                                ${stopLossPrice ? `
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">üõë Stop-Loss:</span>
                                    <strong style="color: #ef4444;">$${stopLossPrice.toFixed(2)} (${stopLossPercent?.toFixed(1)}%)</strong>
                                </div>
                                ` : ''}
                                ${takeProfitPrice ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">üéØ Take-Profit:</span>
                                    <strong style="color: #10b981;">$${takeProfitPrice.toFixed(2)} (${takeProfitPercent?.toFixed(1)}%)</strong>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <button 
                            class="button" 
                            onclick="executeManualTrade()"
                            style="width: 100%; background: ${selectedTradeAction === 'BUY' ? '#10b981' : '#ef4444'}; font-size: 16px; padding: 14px; font-weight: 600;">
                            ‚ö° Execute ${selectedTradeAction} Order
                        </button>
                    </div>
                `;
                
            } catch (error) {
                previewArea.innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ‚ùå Preview failed: ${error.message}
                    </div>
                `;
            }
        }

        async function executeManualTrade(confirmWarnings = false) {
            const symbol = document.getElementById('manualTradeSymbol').value.toUpperCase().trim();
            const quantity = parseFloat(document.getElementById('manualTradeQuantity').value);
            const quantityType = document.getElementById('quantityType').value;
            const addStopLoss = document.getElementById('addStopLoss').checked;
            const stopLossPrice = addStopLoss ? parseFloat(document.getElementById('stopLossPrice').value) : null;
            const takeProfitPrice = addStopLoss ? parseFloat(document.getElementById('takeProfitPrice').value) : null;
            
            const previewArea = document.getElementById('tradePreviewArea');
            
            // Initial confirmation (only if not already confirming warnings)
            if (!confirmWarnings) {
                const confirmed = await showConfirm(
                    'Execute Trade',
                    `Execute ${selectedTradeAction} order for <strong>${symbol}</strong>?<br><br>This will ${selectedTradeAction === 'BUY' ? 'deduct funds from' : 'add funds to'} your portfolio.`,
                    { confirmText: `Execute ${selectedTradeAction}`, confirmColor: selectedTradeAction === 'BUY' ? '#10b981' : '#ef4444' }
                );
                if (!confirmed) return;
            }
            
            try {
                // Show executing state
                previewArea.innerHTML = `
                    <div style="padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; text-align: center;">
                        <div style="font-size: 18px; font-weight: 600; color: #1e40af; margin-bottom: 10px;">
                            ‚è≥ Executing Trade...
                        </div>
                        <div style="color: #6b7280; font-size: 14px;">
                            Processing your ${selectedTradeAction} order for ${symbol}
                        </div>
                    </div>
                `;
                
                // Get current price and calculate actual quantity
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) {
                    throw new Error('Could not fetch price for ' + symbol);
                }
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;
                
                let actualQuantity = quantity;
                if (quantityType === 'usd') {
                    actualQuantity = quantity / currentPrice;
                } else if (quantityType === 'percent') {
                    const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                    const portfolio = await portfolioResponse.json();
                    const portfolioValue = portfolio.totalValue;
                    const usdAmount = (portfolioValue * quantity) / 100;
                    actualQuantity = usdAmount / currentPrice;
                }
                
                // Prepare trade payload
                const tradePayload = {
                    symbol,
                    side: selectedTradeAction,
                    quantity: actualQuantity,
                    reasoning: 'Manual trade - User decision',
                    confirmWarnings
                };
                
                // Add stop-loss and take-profit if provided
                if (stopLossPrice) {
                    tradePayload.stopLoss = stopLossPrice;
                }
                if (takeProfitPrice) {
                    tradePayload.takeProfit = takeProfitPrice;
                }
                
                // Execute trade via API
                const response = await fetch(`${API_BASE}/trade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tradePayload)
                });
                
                const result = await response.json();
                
                // Check if warnings need confirmation
                if (result.requiresConfirmation && result.warnings) {
                    const confirmed = await showWarning(
                        'Risk Warnings',
                        result.warnings,
                        { 
                            confirmText: 'Proceed Anyway',
                            cancelText: 'Cancel Trade'
                        }
                    );
                    
                    if (confirmed) {
                        // Re-execute with confirmation
                        return executeManualTrade(true);
                    } else {
                        previewArea.innerHTML = `
                            <div style="padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; text-align: center;">
                                <div style="font-size: 18px; font-weight: 600; color: #92400e; margin-bottom: 10px;">
                                    Trade Cancelled
                                </div>
                                <div style="color: #6b7280; font-size: 14px;">
                                    You chose not to proceed with the trade due to risk warnings.
                                </div>
                                <button 
                                    class="button" 
                                    onclick="previewTrade()"
                                    style="margin-top: 15px; background: #667eea;">
                                    ‚Üê Back to Preview
                                </button>
                            </div>
                        `;
                        return;
                    }
                }
                
                if (!response.ok) {
                    const errorMessage = result.message || result.error || 'Trade execution failed';
                    throw new Error(errorMessage);
                }
                
                const trade = result;
                
                // Show success message
                previewArea.innerHTML = `
                    <div style="padding: 20px; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                            <h3 style="margin: 0; color: #065f46;">Trade Executed Successfully!</h3>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; font-size: 14px;">
                            <div style="display: grid; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Action:</span>
                                    <strong style="color: ${selectedTradeAction === 'BUY' ? '#10b981' : '#ef4444'};">${selectedTradeAction}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Symbol:</span>
                                    <strong>${symbol}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Quantity:</span>
                                    <strong>${actualQuantity.toFixed(8)} ${symbol}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">Price:</span>
                                    <strong>$${currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}</strong>
                                </div>
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; font-size: 16px;">
                                    <strong>Total:</strong>
                                    <strong style="color: #10b981;">$${trade.totalCost?.toFixed(2) || (actualQuantity * currentPrice).toFixed(2)}</strong>
                                </div>
                                ${stopLossPrice ? `
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">üõë Stop-Loss Active:</span>
                                    <strong style="color: #ef4444;">$${stopLossPrice.toFixed(2)}</strong>
                                </div>
                                ` : ''}
                                ${takeProfitPrice ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #6b7280;">üéØ Take-Profit Active:</span>
                                    <strong style="color: #10b981;">$${takeProfitPrice.toFixed(2)}</strong>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e; text-align: center;">
                            <strong>üìä Portfolio Updated!</strong> Your holdings and balance have been updated.
                        </div>
                    </div>
                `;
                
                // Refresh portfolio and trade history
                setTimeout(() => {
                    loadPortfolio();
                    loadTrades();
                }, 1000);
                
                // Clear form after 3 seconds
                setTimeout(() => {
                    document.getElementById('manualTradeSymbol').value = '';
                    document.getElementById('manualTradeQuantity').value = '';
                    document.getElementById('addStopLoss').checked = false;
                    document.getElementById('stopLossPrice').value = '';
                    document.getElementById('takeProfitPrice').value = '';
                    toggleAdvancedOptions();
                    previewArea.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                console.error('Trade execution error:', error);
                previewArea.innerHTML = `
                    <div style="padding: 20px; background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                        <h3 style="margin: 0 0 10px 0; color: #991b1b;">Trade Execution Failed</h3>
                        <div style="background: white; padding: 12px; border-radius: 6px; color: #6b7280; font-size: 14px;">
                            ${error.message}
                        </div>
                        <button 
                            class="button" 
                            onclick="previewTrade()"
                            style="margin-top: 15px; background: #667eea;">
                            ‚Üê Back to Preview
                        </button>
                    </div>
                `;
            }
        }

        // ============================================
        // END MANUAL TRADING FUNCTIONS
        // ============================================

        // ============================================
        // SELL POSITION FUNCTIONS
        // ============================================

        async function sellPosition(symbol, quantity) {
            // Confirm sale
            const confirmed = await showConfirm(
                'Sell Position',
                `Sell entire <strong>${symbol}</strong> position?<br><br>` +
                `<div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin: 12px 0;">` +
                `<strong>Quantity:</strong> ${quantity.toFixed(8)} ${symbol}` +
                `</div>` +
                `This will close your position and convert to cash.`,
                { confirmText: 'Sell Position', confirmColor: '#ef4444' }
            );
            if (!confirmed) return;

            try {
                // Get current price
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                if (!priceResponse.ok) {
                    throw new Error('Could not fetch price for ' + symbol);
                }
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Calculate expected proceeds
                const subtotal = quantity * currentPrice;
                const fee = subtotal * 0.001;
                const proceeds = subtotal - fee;

                // Execute sell trade
                const response = await fetch(`${API_BASE}/trade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        side: 'SELL',
                        quantity: quantity,
                        reasoning: 'Manual sell - User closed position',
                        confirmWarnings: true  // SELL operations don't need warnings
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    const errorMessage = result.message || result.error || 'Failed to sell position';
                    throw new Error(errorMessage);
                }

                const trade = result;

                // Show success message
                await showSuccess(
                    'Position Sold Successfully!',
                    `<div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin: 12px 0;">` +
                    `<div style="margin: 8px 0;"><strong>Sold:</strong> ${quantity.toFixed(8)} ${symbol}</div>` +
                    `<div style="margin: 8px 0;"><strong>Price:</strong> $${currentPrice.toFixed(2)}</div>` +
                    `<div style="margin: 8px 0;"><strong>Proceeds:</strong> $${proceeds.toFixed(2)}</div>` +
                    `</div>`
                );

                // Refresh portfolio
                loadPortfolio();
                loadTrades();

            } catch (error) {
                console.error('Sell execution error:', error);
                await showError('Sell Failed', error.message);
            }
        }

        // ============================================
        // END SELL POSITION FUNCTIONS
        // ============================================

        // Close modals when clicking outside
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal');
            const infoModal = document.getElementById('infoModal');
            const customModal = document.getElementById('customModal');
            
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
            if (event.target === infoModal) {
                closeInfoModal();
            }
            if (event.target === customModal) {
                closeCustomModal();
            }
        }

        // ============================================
        // CUSTOM MODAL SYSTEM
        // ============================================

        let modalResolveCallback = null;

        function showModal(options) {
            return new Promise((resolve) => {
                modalResolveCallback = resolve;
                
                const modal = document.getElementById('customModal');
                const header = document.getElementById('modalHeader');
                const body = document.getElementById('modalBody');
                const footer = document.getElementById('modalFooter');
                
                // Set icon and title
                header.innerHTML = `<h3>${options.icon || ''} ${options.title || 'Notification'}</h3>`;
                
                // Set body content
                body.innerHTML = options.message || '';
                
                // Clear and set footer buttons
                footer.innerHTML = '';
                
                if (options.type === 'confirm') {
                    // Confirm dialog with Yes/No
                    footer.innerHTML = `
                        <button class="button" onclick="modalResponse(false)" style="background: #6b7280;">
                            ${options.cancelText || 'Cancel'}
                        </button>
                        <button class="button" onclick="modalResponse(true)" style="background: ${options.confirmColor || '#667eea'};">
                            ${options.confirmText || 'Confirm'}
                        </button>
                    `;
                } else {
                    // Alert dialog with OK only
                    footer.innerHTML = `
                        <button class="button" onclick="modalResponse(true)" style="background: ${options.confirmColor || '#667eea'};">
                            ${options.confirmText || 'OK'}
                        </button>
                    `;
                }
                
                // Show modal
                modal.classList.add('active');
            });
        }

        function modalResponse(result) {
            closeCustomModal();
            if (modalResolveCallback) {
                modalResolveCallback(result);
                modalResolveCallback = null;
            }
        }

        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.classList.remove('active');
        }

        // Convenience functions
        async function showAlert(title, message, options = {}) {
            return await showModal({
                type: 'alert',
                icon: options.icon || 'üí°',
                title,
                message,
                confirmText: options.confirmText || 'OK',
                confirmColor: options.confirmColor
            });
        }

        async function showConfirm(title, message, options = {}) {
            return await showModal({
                type: 'confirm',
                icon: options.icon || '‚ùì',
                title,
                message,
                confirmText: options.confirmText || 'Confirm',
                cancelText: options.cancelText || 'Cancel',
                confirmColor: options.confirmColor
            });
        }

        async function showWarning(title, warnings, options = {}) {
            const warningList = warnings.map((w, i) => `<li>${w}</li>`).join('');
            const message = `
                <div class="modal-warning-list">
                    <ol style="margin: 0; padding-left: 20px;">
                        ${warningList}
                    </ol>
                </div>
                <p style="margin-top: 16px; color: #6b7280;">
                    ${options.description || 'These conditions exceed automated trading guidelines.'}
                </p>
            `;
            
            return await showModal({
                type: 'confirm',
                icon: '‚ö†Ô∏è',
                title,
                message,
                confirmText: options.confirmText || 'Proceed Anyway',
                cancelText: options.cancelText || 'Cancel',
                confirmColor: '#f59e0b'
            });
        }

        async function showSuccess(title, message, options = {}) {
            return await showModal({
                type: 'alert',
                icon: '‚úÖ',
                title,
                message,
                confirmText: options.confirmText || 'OK',
                confirmColor: '#10b981'
            });
        }

        async function showError(title, message, options = {}) {
            return await showModal({
                type: 'alert',
                icon: '‚ùå',
                title,
                message,
                confirmText: options.confirmText || 'OK',
                confirmColor: '#ef4444'
            });
        }

        // ============================================
        // END CUSTOM MODAL SYSTEM
        // ============================================

        // ============================================
        // POSITION DETAILS & PROTECTION MANAGEMENT
        // ============================================

        async function openPositionDetails(symbol) {
            try {
                // Fetch current portfolio and position data
                const portfolioResponse = await fetch(`${API_BASE}/portfolio`);
                const portfolio = await portfolioResponse.json();
                const position = portfolio.positions.find(p => p.symbol === symbol);

                if (!position) {
                    await showError('Position Not Found', `Could not find position for ${symbol}`);
                    return;
                }

                // Get current price
                const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
                const priceData = await priceResponse.json();
                const currentPrice = priceData.price;

                // Calculate percentages
                const priceChange = ((currentPrice - position.averagePrice) / position.averagePrice) * 100;
                const stopLossPercent = position.stopLoss ? (((currentPrice - position.stopLoss) / currentPrice) * 100).toFixed(1) : null;
                const takeProfitPercent = position.takeProfit ? (((position.takeProfit - currentPrice) / currentPrice) * 100).toFixed(1) : null;

                const message = `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Quantity</div>
                                <div style="font-weight: 600;">${position.quantity.toFixed(8)} ${symbol}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Entry Price</div>
                                <div style="font-weight: 600;">$${position.averagePrice.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Current Price</div>
                                <div style="font-weight: 600; color: ${priceChange >= 0 ? '#10b981' : '#ef4444'};">
                                    $${currentPrice.toFixed(2)}
                                    <span style="font-size: 12px;">(${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%)</span>
                                </div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 13px;">Current Value</div>
                                <div style="font-weight: 600;">$${position.currentValue.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 12px 0; color: #1f2937;">üõ°Ô∏è Position Protection</h4>

                    <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span>Stop Loss</span>
                            ${position.stopLoss ? 
                                `<button onclick="editProtection('${symbol}', 'stopLoss', ${position.stopLoss})" class="button" style="padding: 4px 8px; font-size: 11px; background: #667eea;">Edit</button>` :
                                `<button onclick="editProtection('${symbol}', 'stopLoss', null)" class="button" style="padding: 4px 8px; font-size: 11px; background: #10b981;">+ Add</button>`
                            }
                        </div>
                        ${position.stopLoss ? `
                            <div style="color: #92400e;">
                                Price: <strong>$${position.stopLoss.toFixed(2)}</strong> (-${stopLossPercent}% from current)
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                Will auto-sell if price drops to this level
                            </div>
                        ` : `
                            <div style="color: #6b7280; font-size: 13px;">
                                No stop loss set. Position is not protected from losses.
                            </div>
                        `}
                    </div>

                    <div style="background: #d1fae5; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span>Take Profit</span>
                            ${position.takeProfit ? 
                                `<button onclick="editProtection('${symbol}', 'takeProfit', ${position.takeProfit})" class="button" style="padding: 4px 8px; font-size: 11px; background: #667eea;">Edit</button>` :
                                `<button onclick="editProtection('${symbol}', 'takeProfit', null)" class="button" style="padding: 4px 8px; font-size: 11px; background: #10b981;">+ Add</button>`
                            }
                        </div>
                        ${position.takeProfit ? `
                            <div style="color: #065f46;">
                                Price: <strong>$${position.takeProfit.toFixed(2)}</strong> (+${takeProfitPercent}% from current)
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                Will auto-sell if price rises to this level
                            </div>
                        ` : `
                            <div style="color: #6b7280; font-size: 13px;">
                                No take profit set. Position will not auto-sell on gains.
                            </div>
                        `}
                    </div>

                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-size: 12px; color: #6b7280;">
                        üí° <strong>Tip:</strong> The position monitor checks prices every 5 minutes and will automatically execute sells when protection levels are reached.
                    </div>
                `;

                await showModal({
                    type: 'alert',
                    icon: 'üìã',
                    title: `${symbol} Position Details`,
                    message,
                    confirmText: 'Close',
                    confirmColor: '#667eea'
                });

            } catch (error) {
                console.error('Failed to load position details:', error);
                await showError('Load Failed', 'Could not load position details. Please try again.');
            }
        }

        async function editProtection(symbol, type, currentValue) {
            const isStopLoss = type === 'stopLoss';
            const title = isStopLoss ? 'üõ°Ô∏è Set Stop Loss' : 'üéØ Set Take Profit';
            const label = isStopLoss ? 'Stop Loss Price' : 'Take Profit Price';
            const hint = isStopLoss ? 
                'Price level to automatically sell and limit losses' : 
                'Price level to automatically sell and lock in profits';

            // Get current price for validation
            const priceResponse = await fetch(`${API_BASE}/price/${symbol}`);
            const priceData = await priceResponse.json();
            const currentPrice = priceData.price;

            const message = `
                <div style="margin-bottom: 16px;">
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <strong>Current Price:</strong> $${currentPrice.toFixed(2)}
                    </div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">${label}</label>
                    <input 
                        type="number" 
                        id="protectionPriceInput" 
                        value="${currentValue || ''}"
                        placeholder="Enter price (e.g., ${isStopLoss ? (currentPrice * 0.9).toFixed(2) : (currentPrice * 1.1).toFixed(2)})"
                        step="0.01"
                        min="0.01"
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                    />
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        ${hint}
                    </div>
                </div>
            `;

            const confirmed = await showModal({
                type: 'confirm',
                icon: isStopLoss ? 'üõ°Ô∏è' : 'üéØ',
                title,
                message,
                confirmText: currentValue ? 'Update' : 'Set',
                cancelText: currentValue ? 'Remove' : 'Cancel',
                confirmColor: '#667eea'
            });

            const priceInput = document.getElementById('protectionPriceInput');
            const newPrice = priceInput ? parseFloat(priceInput.value) : null;

            if (confirmed && newPrice) {
                // User wants to set/update
                await saveProtection(symbol, type, newPrice);
            } else if (!confirmed && currentValue) {
                // User clicked "Remove"
                await saveProtection(symbol, type, null);
            }
        }

        async function saveProtection(symbol, type, price) {
            try {
                // Only send the value being updated, don't send undefined for the other
                const payload = {};
                payload[type] = price;

                const response = await fetch(`${API_BASE}/holdings/${symbol}/protection`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to update protection');
                }

                await showSuccess(
                    'Protection Updated',
                    `${type === 'stopLoss' ? 'Stop loss' : 'Take profit'} ${price ? 'set to $' + price.toFixed(2) : 'removed'} for ${symbol}`
                );

                // Refresh portfolio to show updated data
                loadPortfolio();

            } catch (error) {
                console.error('Failed to save protection:', error);
                await showError('Update Failed', error.message);
            }
        }

        // ============================================
        // END POSITION DETAILS & PROTECTION MANAGEMENT
        // ============================================
    </script>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalHeader" class="modal-header">
                <h3>Notification</h3>
            </div>
            <div id="modalBody" class="modal-body">
                Modal content goes here
            </div>
            <div id="modalFooter" class="modal-footer">
                <button class="button">OK</button>
            </div>
        </div>
    </div>

</body>
</html>
